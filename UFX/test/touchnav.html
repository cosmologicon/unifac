<!DOCTYPE html>
<link href='http://fonts.googleapis.com/css?family=Contrail+One' rel='stylesheet' type='text/css'>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>UFX.touch navigation test</title>
<script src="../src/draw.js"></script>
<script src="../src/ticker.js"></script>
<script src="../src/noise.js"></script>
<script src="../src/maximize.js"></script>
<script src="../src/mouse.js"></script>
<script src="../src/key.js"></script>
<script src="../src/random.js"></script>
<script src="../src/texture.js"></script>
<script src="../src/touch.js"></script>
<script src="UFX.js"></script>
<h1>UFX.touch navigation test</h1>
<canvas id="canvas" style="border: 40px gray outset"></canvas>
<script type="text/javascript">
var canvas = document.getElementById("canvas")
canvas.width = 600 ; canvas.height = 400
var context = canvas.getContext("2d")
UFX.draw.setcontext(context)

UFX.draw("fs black f0 fs white textalign center font 40px~'sans-serif' ft Tap~or~click~to~begin 300 200")

var n = 0, touching, backdrop = null
canvas.onmousedown = function (event) {
	if (backdrop) return
	UFX.mouse.init(canvas)
	init()
}
canvas.ontouchstart = function (event) {
	UFX.touch.init(canvas)
	UFX.mouse.active = false
	touching = true
	init()
}

function init() {
	UFX.maximize.resizemode = "total"
	UFX.maximize.fill(canvas)

	UFX.key.init()
	UFX.key.remaparrows(true)
	UFX.key.watchlist = "left right up down esc".split(" ")
	UFX.key.qdown = true

	backdrop = UFX.texture.terrain({shadex: 1, shadey: 2, scalex: 32, scaley: 32})
	UFX.draw(backdrop.context, "[ alpha 0.7 fs black f0 ]")
	clouds = UFX.texture.clouds({xscale: 8, yscale: 8, sharpness: -2})

	backdrop = UFX.texture.buffertile(backdrop)
	clouds = UFX.texture.buffertile(clouds)

//	UFX.draw("fs black f0")
//	context.drawImage(clouds, 0, 0)
//	clouds.drawclip(context, 300,20)
//	clouds.drawclip(context, 556,20)
//	clouds.drawclip(context, 300,276)

	UFX.ticker.register(think)
}

var x0 = 0, y0 = 0, dragpos = null, cx0 = 0, cy0 = 0, cfactor = 2, reeling = null, rfactor = 1
function think(dt) {
	if (touching) {
		var tstate = UFX.touch.state()
		for (var j in tstate.deltas) {
			var d = tstate.deltas[j]
			x0 -= d[0]
			y0 -= d[1]
		}
		if (JSON.stringify(tstate.ps) != "{}") reeling = null
		if (tstate.release.length) {
			reeling = tstate.release[0].v
		}
		if (reeling) {
			var vx = reeling[0], vy = reeling[1]
			x0 -= rfactor * vx * dt
			y0 -= rfactor * vy * dt
			var f = Math.exp(-4 * dt)
			reeling = Math.abs(vx) + Math.abs(vy) < 1 ? null : [f * vx, f * vy]
		}
	} else {
		var mstate = UFX.mouse.state()
		if (mstate.left.drag) {
			x0 -= mstate.left.drag.dx
			y0 -= mstate.left.drag.dy
		}
	}

	var x = Math.round(x0), y = Math.round(y0)
	var sx2 = 0.5 * canvas.width, sy2 = 0.5 * canvas.height, z = 4, s = 256 * z
	UFX.draw("[ t", sx2 - x, sy2 - y)
	var ix0 = Math.floor((x - sx2) / s)
	var ix1 = Math.floor((x + sx2) / s) + 1
	var iy0 = Math.floor((y - sy2) / s)
	var iy1 = Math.floor((y + sy2) / s) + 1
	for (var ix = ix0 ; ix < ix1 ; ++ix) {
		for (var iy = iy0 ; iy < iy1 ; ++iy) {
			UFX.draw("[ t", s*ix, s*iy, "z", z, z)
			backdrop.drawclip(context)
			UFX.draw("]")
		}
	}
	UFX.draw("]")


	cx0 += 10 * dt
	cy0 += 12 * dt
	z = z * cfactor
	s = 256 * z
	var x = Math.round(cx0 + x0 * cfactor), y = Math.round(cy0 + y0 * cfactor)
	UFX.draw("[ t", sx2 - x, sy2 - y)
	var ix0 = Math.floor((x - sx2) / s)
	var ix1 = Math.floor((x + sx2) / s) + 1
	var iy0 = Math.floor((y - sy2) / s)
	var iy1 = Math.floor((y + sy2) / s) + 1
	for (var ix = ix0 ; ix < ix1 ; ++ix) {
		for (var iy = iy0 ; iy < iy1 ; ++iy) {
			UFX.draw("[ alpha 0.5 t", s*ix, s*iy, "z", z, z)
			clouds.drawclip(context)
			UFX.draw("]")
		}
	}
	UFX.draw("]")
	
	UFX.draw("fs orange font 60px~'Contrail~One' textalign left textbaseline top shadowx 2 shadowy 2 shadowcolor black")
	context.fillText(UFX.ticker.getfpsstr(), 10, 10)
}

</script>
