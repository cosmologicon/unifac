<!doctype html>
<!-- Unminified version available at: https://code.google.com/p/unifac/source/browse/#hg%2Fastra -->
<title>Ad Astra</title>
<canvas id="canvas"></canvas>
<script>"use strict";var UFX=UFX||{};UFX.resource={images:{},sounds:{},data:{},jsontypes:"js json".split(" "),imagetypes:"png gif jpg jpeg bmp tiff".split(" "),soundtypes:"wav mp3 ogg au".split(" "),rawtypes:"csv txt frag vert".split(" "),base:null,soundvolume:undefined,musicvolume:undefined,audiovolume:undefined,onload:function(){},onloading:function(a){},load:function(){var c=UFX.resource._extractlist(arguments);for(var a=0;a<c.length;++a){var b=c[a];this._load(b[0],b[1])}if(this._toload===0){setTimeout(this.onload,0)}},loadimage:function(){var c=this._extractlist(arguments);for(var a=0;a<c.length;++a){var b=c[a];this._loadimage(b[0],b[1])}},loadsound:function(){var c=this._extractlist(arguments);for(var a=0;a<c.length;++a){var b=c[a];this._loadsound(b[0],b[1])}},loadjson:function(){var c=this._extractlist(arguments);for(var a=0;a<c.length;++a){var b=c[a];this._loadjson(b[0],b[1])}},loadwebfonts:function(){WebFontConfig={google:{families:Array.prototype.slice.call(arguments)},fontactive:UFX.resource._onload};var a=document.createElement("script");a.src="https://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js";a.type="text/javascript";a.async="true";document.getElementsByTagName("head")[0].appendChild(a);this._toload+=arguments.length},setsoundvolume:function(a){this.soundsvolume=a},setmusicvolume:function(a){this.musicvolume=a;if(this.musicplaying){this.musicplaying.volume=this._getmusicvolume()}},setaudiovolume:function(a){this.audiovolume=a;if(this.musicplaying){this.musicplaying.volume=this._getmusicvolume()}},playsound:function(a){var c=this.sounds[a];if(!c){console.log("Missing sound: "+a);return}var b=this.soundvolume===undefined?this.audiovolume:this.soundvolume;if(b===undefined){b=1}c.volume=b;c.play()},musicplaying:null,_getmusicvolume:function(){if(this.musicvolume!==undefined){return this.musicvolume}if(this.audiovolume!==undefined){return this.audiovolume}return 1},playmusic:function(b,c){this._completependingfades();if(!b){return this.stopmusic()}var a=this.sounds[b];if(!a){console.log("Missing music: "+b);return}if(a===this.musicplaying){return}this.stopmusic();a.volume=this._getmusicvolume();a.currentTime=0;a.play();a.loop=!c;this.musicplaying=a},stopmusic:function(){this._completependingfades();if(this.musicplaying){this.musicplaying.pause()}this.musicplaying=null},_fadeouttime0:1400,_fadeintime0:1400,_fadegap0:0,setfadetime:function(c,b,a){if(c!==undefined){this._fadeouttime0=c}if(b!==undefined){this._fadeintime0=b}if(a!==undefined){this._fadegap0=a}},setcrossfade:function(a){if(a===undefined){a=this._fadetime}this.setfadetime(a,a,-a)},_completependingfades:function(){if(this._fadetimeout){window.clearTimeout(this._fadetimeout);this._fadeinstart=-1;this._fadeoutstart=-1;this._fadecallback()}},fadetomusic:function(d,c,b,a,e){this._completependingfades();if(this.musicplaying&&d&&this.sounds[d]===this.musicplaying){return}this._fadeouttime=c===undefined?this._fadeouttime0:c;this._fadeintime=b===undefined?this._fadeintime0:b;this._fadegap=a===undefined?this._fadegap0:a;this._fadeoutstart=Date.now();this._fadeinstart=this._fadeoutstart+(this.musicplaying?this._fadeintime+this._fadegap:0);this._pendingmname=d;this._pendingnoloop=e;this._outgoingmusic=this.musicplaying;this.musicplaying=null;this._fadecallback()},crossfadetomusic:function(b,a,c){if(a===undefined){a=this._fadeouttime}this.fadetomusic(b,a,a,-a,c)},_fadecallback:function(){if(this._outgoingmusic){var b=Date.now()-this._fadeoutstart;var c=this._fadeouttime>0?1-b/this._fadeouttime:b>0?0:1;if(c>0){this._outgoingmusic.volume=c*this._getmusicvolume()}else{this._outgoingmusic.pause();this._outgoingmusic=null}}if(this._pendingmname){var d=Date.now()-this._fadeinstart;var e=this._fadeintime>0?d/this._fadeintime:d>0?1:0;if(e>0){if(!this.musicplaying){var a=this.sounds[this._pendingmname];if(!a){console.log("Missing music: "+mname)}else{a.currentTime=0;a.volume=0;a.play();a.loop=!this._pendingnoloop;this.musicplaying=a}}if(e>=1){this.musicplaying.volume=this._getmusicvolume();this._pendingmname=null}else{this.musicplaying.volume=e*this._getmusicvolume()}}}if(this._outgoingmusic||this._pendingmname){this._fadetimeout=window.setTimeout(this._fadecallback.bind(this),100)}else{this._fadetimeout=null}},Multisound:function(a,b){if(!(this instanceof UFX.resource.Multisound)){return new UFX.resource.SoundRandomizer(a,b)}this._init(a,b)},SoundRandomizer:function(b,c){if(!(this instanceof UFX.resource.SoundRandomizer)){return new UFX.resource.SoundRandomizer(b,c)}this._sounds=[];for(var a=0;a<b.length;++a){this._sounds.push(typeof b[a]=="string"?UFX.resource.sounds[b[a]]:b[a])}this._nskip=Math.min(this._sounds.length-1,(c||3));this._played=[];this.volume=1},mergesounds:function(){for(var b=0;b<arguments.length;++b){var c=[],a=arguments[b];for(var d in UFX.resource.sounds){if(d.indexOf(a)==0){c.push(d)}}this.sounds[a]=this.SoundRandomizer(c)}},_seturl:function(a){if(!this.base){return a}var b=UFX.resource.base.length;if(!b){return a}return this.base+(this.base.charAt(b-1)=="/"?"":"/")+a},_load:function(b,a){var c=a.split(".").pop();if(this.imagetypes.indexOf(c)>-1){return this._loadimage(b,a)}else{if(this.soundtypes.indexOf(c)>-1){return this._loadsound(b,a)}else{if(this.jsontypes.indexOf(c)>-1){return this._loadjson(b,a)}else{if(this.rawtypes.indexOf(c)>-1){return this._loaddata(b,a)}}}}console.log("Treating unknown extension "+c+" as raw data");return this._loaddata(b,a)},_loadimage:function(b,c){var a=new Image();a.onload=this._onload;a.src=this._seturl(c);a.iname=b;this.images[b]=a;++this._toload},_loadsound:function(b,a){var c=new Audio();c.addEventListener("canplaythrough",this._onload,false);c.src=this._seturl(a);c.aname=b;this.sounds[b]=c;++this._toload},_loadjson:function(a,d){var b=new XMLHttpRequest();b.overrideMimeType("application/json");b.open("GET",d,true);var c=this;b.onload=function(){UFX.resource.data[a]=JSON.parse(b.responseText);UFX.resource._onload()};b.send(null);++this._toload},_loaddata:function(d,a){var b=new XMLHttpRequest();b.open("GET",a,true);var c=this;b.onload=function(){UFX.resource.data[d]=b.responseText;UFX.resource._onload()};b.send(null);++this._toload},_extractlist:function(e){var d=[];for(var c=0;c<e.length;++c){var a=e[c];if(typeof a=="string"){d.push([a,a])}else{if(a instanceof Array){for(var b=0;b<a.length;++b){d.push([a[b],a[b]])}}else{for(var b in a){d.push([b,a[b]])}}}}return d},_toload:0,_loaded:0,_onload:function(){++UFX.resource._loaded;var a=UFX.resource._loaded/UFX.resource._toload;UFX.resource.onloading(a);if(UFX.resource._loaded==UFX.resource._toload){UFX.resource.onload()}}};var WebFontConfig;UFX.resource.Multisound.prototype={_init:function(b,d){this.src=typeof b=="string"?b:b.src;this._sounds=[];this._n=d||10;this._k=0;this.volume=1;for(var a=0;a<this._n;++a){var c=new Audio();c.src=this.src;this._sounds.push(c)}},play:function(){var a=this._sounds[this._k++];this._k%=this._n;a.volume=this.volume;a.play()},pause:function(){for(var a=0;a<this._n;++a){this._sounds[a].pause()}}};UFX.resource.SoundRandomizer.prototype={play:function(){do{var a=UFX.random.rand(this._sounds.length)}while(this._played.indexOf(a)>-1);var b=this._sounds[a];b.volume=this.volume;b.play();if(this._nskip){this._played.push(a);while(this._played.length>=this._nskip){this._played=this._played.slice(1)}}},pause:function(){for(var a=0;a<this._sounds.length;++a){this._sounds[a].pause()}}};"use strict";var UFX=UFX||{};UFX._draw=function(){var k=[];function e(){for(var j=0;j<arguments.length;++j){var h=arguments[j];if(h.split){k.push.apply(k,h.split(" "))}else{if(h instanceof Array){e.apply(this,h)}else{k.push(h)}}}}e.apply(this,arguments);var l=this;function b(h){if(typeof h!=="string"){return h}switch(h.substr(0,3)){case"lg~":return UFX._draw.lingrad.apply(l,h.substr(3).split("~"));case"rg~":return UFX._draw.radgrad.apply(l,h.substr(3).split("~"));default:return h}}for(var c=0;c<k.length;++c){switch(k[c].toLowerCase()){case"b":case"(":case"beginpath":this.beginPath();break;case")":case"closepath":this.closePath();break;case"m":case"moveto":this.moveTo(+k[++c],+k[++c]);break;case"l":case"lineto":this.lineTo(+k[++c],+k[++c]);break;case"q":case"quadraticcurveto":this.quadraticCurveTo(+k[++c],+k[++c],+k[++c],+k[++c]);break;case"c":case"beziercurveto":this.bezierCurveTo(+k[++c],+k[++c],+k[++c],+k[++c],+k[++c],+k[++c]);break;case"a":case"arc":this.arc(+k[++c],+k[++c],+k[++c],+k[++c],+k[++c]);break;case"aa":case"antiarc":this.arc(+k[++c],+k[++c],+k[++c],+k[++c],+k[++c],true);break;case"arcto":this.arcTo(+k[++c],+k[++c],+k[++c],+k[++c],+k[++c]);break;case"o":case"circle":this.arc(+k[++c],+k[++c],+k[++c],0,2*Math.PI);break;case"rr":case"roundedrect":var g=+k[++c],f=+k[++c],i=+k[++c],d=+k[++c],a=+k[++c];this.beginPath();this.moveTo(g+a,f);this.arcTo(g+i,f,g+i,f+d,a);this.arcTo(g+i,f+d,g,f+d,a);this.arcTo(g,f+d,g,f,a);this.arcTo(g,f,g+i,f,a);this.closePath();break;case"t":case"translate":this.translate(+k[++c],+k[++c]);break;case"r":case"rotate":this.rotate(+k[++c]);break;case"z":case"scale":this.scale(+k[++c],+k[++c]);break;case"zx":case"xscale":this.scale(+k[++c],1);break;case"zy":case"yscale":this.scale(1,+k[++c]);break;case"hflip":this.scale(-1,1);break;case"vflip":this.scale(1,-1);break;case"x":case"transform":this.transform(+k[++c],+k[++c],+k[++c],+k[++c],+k[++c],+k[++c]);break;case"xshear":this.transform(1,0,+k[++c],1,0,0);break;case"yshear":this.transform(1,+k[++c],0,1,0,0);break;case"f":case"fill":this.fill();break;case"s":case"stroke":this.stroke();break;case"fr":case"fillrect":this.fillRect(+k[++c],+k[++c],+k[++c],+k[++c]);break;case"sr":case"strokerect":this.strokeRect(+k[++c],+k[++c],+k[++c],+k[++c]);break;case"fsr":case"fillstrokerect":var g=+k[++c],f=+k[++c],i=+k[++c],d=+k[++c];this.fillRect(g,f,i,d);this.strokeRect(g,f,i,d);break;case"cr":case"clearrect":this.clearRect(+k[++c],+k[++c],+k[++c],+k[++c]);break;case"f0":case"fillall":this.fillRect(0,0,this.canvas.width,this.canvas.height);break;case"c0":case"clearall":this.clearRect(0,0,this.canvas.width,this.canvas.height);break;case"tr":case"tracerect":var g=+k[++c],f=+k[++c],i=+k[++c],d=+k[++c];this.beginPath();this.moveTo(g,f);this.lineTo(g+i,f);this.lineTo(g+i,f+d);this.lineTo(g,f+d);this.closePath();break;case"fs":case"fillstyle":this.fillStyle=b(k[++c]);break;case"ss":case"strokestyle":this.strokeStyle=b(k[++c]);break;case"shadowblur":case"shb":this.shadowBlur=+k[++c];break;case"shadowcolor":case"shc":this.shadowColor=b(k[++c]);break;case"shadowoffsetx":case"shadowx":case"shx":this.shadowOffsetX=+k[++c];break;case"shadowoffsety":case"shadowy":case"shy":this.shadowOffsetY=+k[++c];break;case"shadowoffsetxy":case"shadowxy":case"shxy":this.shadowOffsetX=+k[++c];this.shadowOffsetY=+k[++c];break;case"shadow":case"sh":this.shadowColor=b(k[++c]);this.shadowOffsetX=+k[++c];this.shadowOffsetY=+k[++c];this.shadowBlur=+k[++c];break;case"drawimage":this.drawImage(k[++c],+k[++c],+k[++c]);break;case"drawimage0":this.drawImage(k[++c],0,0);break;case"clip":this.clip();break;case"al":case"alpha":case"globalalpha":this.globalAlpha=+k[++c];break;case"lw":case"linewidth":this.lineWidth=+k[++c];break;case"lc":case"linecap":this.lineCap=k[++c];break;case"textalign":this.textAlign=k[++c];break;case"textbaseline":this.textBaseline=k[++c];break;case"[":case"save":this.save();break;case"]":case"restore":this.restore();break;case"font":this.font=k[++c].replace(/~/g," ");break;case"filltext":case"ft":this.fillText(k[++c].replace(/~/g," "),+k[++c],+k[++c]);break;case"filltext0":case"ft0":this.fillText(k[++c].replace(/~/g," "),0,0);break;case"stroketext":case"st":this.strokeText(k[++c].replace(/~/g," "),+k[++c],+k[++c]);break;case"stroketext0":case"st0":this.strokeText(k[++c].replace(/~/g," "),0,0);break;case"fillstroketext":case"fst":var m=k[++c].replace(/~/g," "),g=+k[++c],f=+k[++c];this.fillText(m,g,f);this.strokeText(m,g,f);break;case"fillstroketext0":case"fst0":var m=k[++c].replace(/~/g," ");this.fillText(m,0,0);this.strokeText(m,0,0);break;default:throw"Unrecognized draw token "+k[c]}}};UFX._draw.circle=function(b,f,d,a,c,e){this.save();this.beginPath();this.arc(b,f,d,0,2*Math.PI);if(a){this.fillStyle=a;this.fill()}if(c||e){if(c){this.strokeStyle=c}if(e){this.lineWidth=e}this.stroke()}this.restore()};UFX._draw.lingrad=function(c,e,b,d){var f=this.createLinearGradient(+c,+e,+b,+d);for(var a=4;a<arguments.length;a+=2){f.addColorStop(+arguments[a],arguments[a+1])}return f};UFX._draw.radgrad=function(e,g,d,c,f,a){var h=this.createRadialGradient(+e,+g,+d,+c,+f,+a);for(var b=6;b<arguments.length;b+=2){h.addColorStop(+arguments[b],arguments[b+1])}return h};UFX.draw=function(a){if(a.beginPath){return UFX._draw.apply(a,Array.prototype.slice.call(arguments,1))}else{if(UFX.draw._context){return UFX._draw.apply(UFX.draw._context,arguments)}else{throw"UFX.draw must be called with context as first argument"}}};for(var mname in UFX._draw){UFX.draw[mname]=(function(b,a){return function(c){if(c.beginPath){return b.apply(c,Array.prototype.slice.call(arguments,1))}else{if(!UFX.draw._context){UFX.draw._context=document.createElement("canvas").getContext("2d")}return b.apply(UFX.draw._context,arguments)}}})(UFX._draw[mname],mname)}UFX.draw.setcontext=function(a){UFX.draw._context=a};UFX.draw.extend=function(a){a.draw=function(){UFX._draw.apply(a,arguments)};for(var b in UFX._draw){a.draw[b]=(function(c){return function(){return c.apply(a,arguments)}})(UFX._draw[b])}};"use strict";var UFX=UFX||{};UFX.maximize={resizemode:"fixed",preventscroll:true,fillcolor:"black",onadjust:null,init:function(a){this.element=a;this.mode=null;function b(c,d){return function(){c[d]()}}this.calladjust=b(this,"adjust");this.getsettings()},setmode:function(a){if(this.mode==a){return}if(this.mode=="fill"){window.removeEventListener("resize",this.calladjust)}if(this.mode=="full"){document.cancelFullscreen();window.removeEventListener("resize",this.calladjust)}this.mode=a;if(this.mode=="fill"){window.addEventListener("resize",this.calladjust)}if(this.mode=="full"){this.element.requestFullscreen();window.addEventListener("resize",this.calladjust)}},adjust:function(){var b=window.innerWidth,a=window.innerHeight;var e=this.element.width,c=this.element.height;var k,j,i,h;if(this.resizemode=="none"){}else{if(this.resizemode=="fixed"){if(e*a>c*b){k=b;j=Math.round(b*c/e)}else{k=Math.round(a*e/c);j=a}}else{if(this.resizemode=="aspect"){if(e*a>c*b){i=k=b;h=j=Math.round(b*c/e)}else{i=k=Math.round(a*e/c);h=j=a}}else{if(this.resizemode=="total"){i=k=b;h=j=a}}}}var g=this.element.style;if(k){g.width=k+"px";g.height=j+"px"}if(i){this.element.width=i;this.element.height=h}if(this.mode=="fill"){var f=b-(k||i||this.element.width);var d=a-(j||h||this.element.height);g.borderLeft=g.borderRight=f>0?(0.5*f+1)+"px "+this.fillcolor+" solid":"none";g.borderTop=g.borderBottom=d>0?(0.5*d+1)+"px "+this.fillcolor+" solid":"none";setTimeout(function(){window.scrollTo(0,1)},1)}else{if(this.mode=="full"){g.borderLeft=g.borderRight="none";g.borderTop=g.borderBottom="none"}}if(this.onadjust){this.onadjust(this.element,this.element.width,this.element.height)}},fill:function(b,a){if(a){this.resizemode=a}if(b){this.init(b)}this.setmode("fill");if(this.preventscroll){document.body.addEventListener("touchstart",this.preventdefault);this.scrollprevented=true}this.adjust();var c=this.element.style;c.position="absolute";c.left="0px";c.top="1px";document.body.style.overflow="hidden"},full:function(c,b){if(b){this.resizemode=b}if(c){this.init(c)}this.setmode("full");var a=this;setTimeout(function(){if(a.getfullscreenelement()===a.element){a.adjust()}else{a.restore()}},100)},maximize:function(c,b){if(b){this.resizemode=b}if(c){this.init(c)}if(!this.element.requestFullscreen){this.fill();return}this.setmode("full");var a=this;setTimeout(function(){if(a.getfullscreenelement()===a.element){}else{a.fill()}},100)},getfullscreenelement:function(){return document.getFullscreenElement},restore:function(){this.setmode();if(this.scrollprevented){document.body.removeEventListener("touchstart",this.preventdefault);this.scrollprevented=false}this.restoresettings();if(this.onadjust){this.onadjust(this.element,this.element.width,this.element.height)}},getsettings:function(){var c=this.element.style,a=this.settings={width:this.element.width,height:this.element.height,overflow:document.body.style.overflow,style:{}};var b="width height position left top borderLeft borderRight borderTop borderBottom border".split(" ");b.forEach(function(d){a.style[d]=c[d]})},restoresettings:function(){var c=this.element.style,a=this.settings;width:this.element.width=this.settings.width;height:this.element.height=this.settings.height;overflow:document.body.style.overflow=this.settings.overflow;var b="width height position left top borderLeft borderRight borderTop borderBottom border".split(" ");b.forEach(function(d){c[d]=a.style[d]})},fillnoresize:function(){es.position="absolute";es.left="0px";es.top="1px";this.setbordersizes(wx-px,wy-py);document.body.style.overflow="hidden"},preventdefault:function(a){a.preventDefault()}};"use strict";var UFX=UFX||{};UFX.key={};UFX.key.active=true;UFX.key.capture=true;UFX.key.qdown=true;UFX.key.qup=true;UFX.key.qcombo=false;UFX.key.combodt=100;UFX.key.watchlist=null;UFX.key.ispressed={};UFX.key.codepressed={};UFX.key.events=function(){var a=UFX.key._downevents.concat(UFX.key._upevents);UFX.key.clearevents();return a};UFX.key.combos=function(){UFX.key._checkcombo();var a=UFX.key._combos;UFX.key.clearcombos();return a};UFX.key.clearevents=function(){UFX.key._downevents=[];UFX.key._upevents=[]};UFX.key.clearcombos=function(a){UFX.key._combos=[];if(a){UFX.key._currentcombo=null}};UFX.key.state=function(){var b={pressed:{}};for(var a in UFX.key.ispressed){if(UFX.key.ispressed[a]){b.pressed[a]=1}}if(UFX.key.qdown){b.down={}}if(UFX.key.qup){b.up={}}UFX.key.events().forEach(function(c){b[c.type][c.name]=1});if(UFX.key.qcombo){b.combo={};UFX.key.combos().forEach(function(c){b.combo[c.kstring]=1})}return b};UFX.key.init=function(a){UFX.key._captureevents(a)};UFX.key.map={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"caps",27:"esc",32:"space",33:"pgup",34:"pgdn",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:"semicolon",61:"equals",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",96:"np0",97:"np1",98:"np2",99:"np3",100:"np4",101:"np5",102:"np6",103:"np7",104:"np8",105:"np9",106:"star",107:"plus",109:"hyphen",110:"period",111:"slash",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"num",188:"comma",190:"period",191:"slash",192:"backtick",219:"openbracket",220:"backslash",221:"closebracket",222:"apostrophe"};UFX.key.remap=function(){for(var c=0;c<arguments.length;++c){var e=arguments[c];for(var b in e){var a=e[b];for(var d in UFX.key.map){if(UFX.key.map[d]===b){UFX.key.map[d]=a}}}}};UFX.key.remaparrows=function(a){UFX.key.remap({A:"left",S:"down",D:"right",W:"up"});if(a){UFX.key.remap({O:"down",comma:"up",",":"up",E:"right"})}};UFX.key.remappunct=function(){UFX.key.remap({semicolon:";",equals:"=",star:"*",plus:"+",hyphen:"-",period:".",slash:"/",comma:",",backtick:"`",openbracket:"[",backslash:"\\",closebracket:"]",apostrophe:"'"})};UFX.key._downevents=[];UFX.key._upevents=[];UFX.key._combos=[];UFX.key._currentcombo=null;UFX.key._captureevents=function(a){a=a||document;if(typeof a=="String"){a=document.getElementById(a)}a.addEventListener("blur",UFX.key._onblur,true);window.onblur=UFX.key._onblur;a.onkeypress=UFX.key._onkeypress;a.onkeyup=UFX.key._onkeyup;a.onkeydown=UFX.key._onkeydown;UFX.key._element=a};UFX.key._onblur=function(b){for(var a in UFX.key.codepressed){UFX.key._storeup(b,a)}return true};UFX.key._watching=function(a){if(!UFX.key.watchlist){return true}return UFX.key.watchlist.indexOf(UFX.key.map[a.which])>-1};UFX.key._onkeypress=function(a){if(!UFX.key.active||!UFX.key._watching(a)){return true}return !UFX.key.capture};UFX.key._onkeydown=function(b){if(!UFX.key.active||!UFX.key._watching(b)){return true}var a=b.which;if(UFX.key.codepressed[a]){return !UFX.key.capture}UFX.key._storedown(b,a);return !UFX.key.capture};UFX.key._onkeyup=function(a){if(!UFX.key.active||!UFX.key._watching(a)){return true}UFX.key._storeup(a,a.which);return !UFX.key.capture};UFX.key._storedown=function(d,c){c=c||d.which;var b=(new Date()).getTime();var e=UFX.key.map[c]||"key#"+c;var a={baseevent:d,type:"down",code:c,name:e,time:b};UFX.key.codepressed[c]=a;if(a.name){UFX.key.ispressed[a.name]=a}if(UFX.key.qdown){UFX.key._downevents.push(a)}if(UFX.key.qcombo){UFX.key._checkcombo();if(UFX.key._currentcombo){UFX.key._currentcombo.keys.push(e)}else{UFX.key._currentcombo={start:b,keys:[e]}}}};UFX.key._storeup=function(d,c){var e=(new Date()).getTime();var b=UFX.key.codepressed[c]?e-UFX.key.codepressed[c].time:0;var a={type:"up",baseevent:d,code:c,name:UFX.key.map[c]||"key#"+c,time:e,dt:b};delete UFX.key.codepressed[c];if(a.name){delete UFX.key.ispressed[a.name]}if(UFX.key.qup){UFX.key._upevents.push(a)}};UFX.key._checkcombo=function(){if(!UFX.key._currentcombo){return}var a=(new Date()).getTime();if(UFX.key._currentcombo.start+UFX.key.combodt<a){var b=UFX.key._currentcombo.keys;b.sort();UFX.key._combos.push({keys:b,kstring:b.join(" "),time:UFX.key._currentcombo.start});UFX.key._currentcombo=null}};"use strict";var UFX=UFX||{};UFX.ticker={defaultopts:{sync:"auto",cthis:null,delay:0,minupf:1,maxupf:1,ups:null,minups:null,maxups:null,fps:30,cfac:null},init:function(c,b,a){this.setcallbacks(c,b);this.setoptions(a);this.resume()},setcallbacks:function(b,a){this._tcallback=b;this._dcallback=a},setoptions:function(a,c){if(!c){for(var b in this.defaultopts){this[b]=this.defaultopts[b]}}if(!a){return}for(var b in this.defaultopts){if(b in a){this[b]=a[b]}}},resume:function(){this.stop();this.resetcounters();this._running=true;this._tick()},stop:function(){if(this._shandle){window.cancelAnimationFrame(this._shandle)}if(this._thandle){clearTimeout(this._thandle)}this._shandle=this._thandle=null;this._running=false},resetcounters:function(){this._accumulator=0;this._dtu=0;this._dtg=0;this._dtf=0;this._lastthink=Date.now();this._lastdraw=Date.now();this.wfactor=1},getrates:function(){return[this.wfps.toPrecision(3)+"fps",this.wups.toPrecision(3)+"ups",this.wfactor.toPrecision(3)+"x"].join(" ")},_tick:function(){if(!this._running){return}var d=Date.now();var q=this._lasttick?(d-this._lasttick)*0.001:0;this._lasttick=d;this._accumulator+=q;var c=this.fps;var h=this.minupf;var p=this.maxupf;var u=this.minups||this.ups||c;var k=this.maxups||this.ups||u;var b=this.cfac||1/u;var e,r,l,o;if(h==0){e=true}else{e=this._accumulator>=h/k}if(!e){r=0;o=h/k}else{if(h>=p){r=h;o=l=Math.min(this._accumulator,h/u)}else{var m=Math.floor(this._accumulator*u);if((m+1)/k<=this._accumulator){m+=1}r=Math.max(Math.min(m,p),h);l=Math.min(r/u,this._accumulator);o=Math.max(h,1)/k}}if(r){this._accumulator-=l;d=Date.now();this._dtu=(1-b*r)*this._dtu+b*0.001*(d-this._lastthink);this._dtg=(1-b*r)*this._dtg+b*l;this._lastthink=d;l/=r;for(var j=0;j<r;++j){this._tcallback.call(this.cthis,l,j,r)}}if(e&&this._dcallback){var s=this._accumulator*u;this._dcallback.call(this.cthis,s);d=Date.now();this._dtf=(1-b)*this._dtf+b*0.001*(d-this._lastdraw);this._lastdraw=d}this._accumulator=Math.max(Math.min(this._accumulator,o),0);this.wups=1/this._dtu;this.wfps=this._dcallback?1/this._dtf:this.wups;this.wfactor=this._dtg/this._dtu;if(!this._running){return}var g=this.sync=="auto"?window.requestAnimationFrame:this.sync;this._shandle=this._thandle=null;var i=(function(f){return function(){f._tick()}})(this);if(g){this._shandle=window.requestAnimationFrame(i)}else{var a=this._lasttick+1000*(o-this._accumulator);var t=Math.max(Math.ceil(a-Date.now()),this.delay);this._thandle=window.setTimeout(i,t)}}};"use strict";var UFX=UFX||{};UFX.SceneStack=function(){if(!(this instanceof UFX.SceneStack)){return new UFX.SceneStack()}this._actionq=[];this._stack=[];this.resolveargs=true;this.recorder=null;this.frozen=false};UFX.SceneStack.prototype={init:function(a,b){a=Object.create(a||null);a.cthis=this;UFX.ticker.init(this.think,this.draw,a,b)},top:function(){var a=this._stack.length;return a?this._stack[a-1]:null},getscene:function(a){if(typeof a==="string"){if(a.substr(0,4)=="new_"){a=a.substr(4);if(!(a in UFX.scenes)){throw"Unrecognized scene: "+a}return new UFX.scenes[a]()}else{if(a.substr(0,7)=="create_"){a=a.substr(7);if(!(a in UFX.scenes)){throw"Unrecognized scene: "+a}return Object.create(UFX.scenes[a])}}if(!(a in UFX.scenes)){throw"Unrecognized scene: "+a}return UFX.scenes[a]}return a},ipush:function(d){if(this.frozen){return}var a=this.top();if(a&&a.suspend){a.suspend()}var e=this.getscene(d);this._stack.push(e);var b=Array.prototype.slice.call(arguments,1);if(this.resolveargs&&e.startargs){b=e.startargs.apply(e,b)}if(this.recorder){this.recorder.addpush(d,b)}if(e.checkpoint&&this.recorder){this.recorder.checkpoint(e.getchaptername?e.getchaptername.apply(e,b):d)}if(e.start){e.start.apply(e,b)}},ipop:function(f){if(this.frozen){return}f=f||1;for(var a=0;a<f;++a){var e=this._stack.pop();if(e.stop){e.stop()}var b=this.top();if(b&&b.resume){b.resume()}if(this.recorder){this.recorder.addpop()}}return e},iswap:function(b){if(this.frozen){return}var d=this._stack.pop();if(d&&d.stop){d.stop()}var e=this.getscene(b);this._stack.push(e);var a=Array.prototype.slice.call(arguments,1);if(this.resolveargs&&e.startargs){a=e.startargs.apply(e,a)}if(this.recorder){this.recorder.addswap(b,a)}if(e.checkpoint&&this.recorder){this.recorder.checkpoint(e.getchaptername?e.getchaptername.apply(e,a):b)}if(e.start){e.start.apply(e,a)}return d},push:function(){this._actionq.push(["push",Array.prototype.slice.call(arguments,0)])},pop:function(){this._actionq.push(["pop",Array.prototype.slice.call(arguments,0)])},swap:function(){this._actionq.push(["swap",Array.prototype.slice.call(arguments,0)])},_resolveq:function(){for(var a=0;a<this._actionq.length;++a){switch(this._actionq[a][0]){case"push":this.ipush.apply(this,this._actionq[a][1]);break;case"pop":this.ipop.apply(this,this._actionq[a][1]);break;case"swap":this.iswap.apply(this,this._actionq[a][1]);break}}this._actionq=[]},think:function(){this._resolveq();var b=this.top();this._lastthinker=b;if(b){var a=arguments;if(this.resolveargs&&b.thinkargs){a=b.thinkargs.apply(b,a)}if(this.recorder){this.recorder.addthink(a)}if(b.think){b.think.apply(b,a)}}},draw:function(){var a=this._lastthinker;if(a&&a.draw){a.draw.apply(a,arguments)}}};UFX.scene=new UFX.SceneStack();UFX.scenes={};"use strict";var UFX=UFX||{};UFX.random=function(d,c){if(typeof c=="undefined"){c=d;d=0;if(typeof c=="undefined"){c=1}}return UFX.random.rand()*(c-d)/4294967296+d};UFX.random.rand=function(a,b){if(typeof b!="undefined"){return a+UFX.random.rand(b-a)}if(typeof UFX.random.seed=="undefined"){UFX.random.setseed()}UFX.random.seed=(1664525*UFX.random.seed+1013904223)%4294967296;return a?Math.floor(UFX.random.seed*a/4294967296):UFX.random.seed};UFX.random.hash=function(d){var c=typeof d=="string"?d:JSON.stringify(d),e=c.length,b=0;for(var a=0;a<e;++a){b+=c.charCodeAt(a);b+=b<<10;b^=b>>>6}b+=b<<3;b^=b>>>11;b+=b<<15;if(b<0){b+=4294967296}return b};UFX.random.setseed=function(a){if(typeof a=="undefined"){a=Math.floor(Math.random()*4294967296)}else{if(typeof a=="number"){a=Math.floor(a)%4294967296}else{a=UFX.random.hash(a)}}UFX.random.seed=a;delete UFX.random.normal._y;return a};UFX.random._seedstack=[];UFX.random.pushseed=function(a){if(typeof UFX.random.seed=="undefined"){UFX.random.setseed()}UFX.random._seedstack.push(UFX.random.seed);UFX.random.setseed(a);return UFX.random.seed};UFX.random.popseed=function(){UFX.random.seed=UFX.random._seedstack.pop();return UFX.random.seed};UFX.random.choice=function(b,a){return a?b.splice(UFX.random.rand(b.length),1)[0]:b[UFX.random.rand(b.length)]};UFX.random.word=function(e,d){var b=[];e=e||8;d=d||"abcdefghijklmnopqrstuvwxyz";for(var c=0;c<e;++c){b.push(UFX.random.choice(d))}return b.join("")};UFX.random.color=function(){return"#"+UFX.random.word(6,"0123456789ABCDEF")};UFX.random.shuffle=function(a){for(var d=a.length-1;d>0;--d){var c=UFX.random.rand(d+1);var b=a[d];a[d]=a[c];a[c]=b}return a};UFX.random.rdisk=function(){var a,b;do{a=UFX.random(-1,1);b=UFX.random(-1,1)}while(a*a+b*b>1);return[a,b]};UFX.random.rsphere=function(){var a,e,c;do{a=UFX.random(-1,1);e=UFX.random(-1,1);c=UFX.random(-1,1)}while(a*a+e*e+c*c>1);var b=Math.sqrt(a*a+e*e+c*c);if(b===0){return[0,0,1]}return[a/b,e/b,c/b]};UFX.random.spread=function(e,c,h,g,d,m){e=e||100;c=c||0.15;h=h||1;g=g||h;d=d||0;m=m||d;var b=[],i=1;while(b.length<e){var l=UFX.random(),k=UFX.random(),a=true;for(var f=0;f<b.length;++f){var p=Math.abs(l-b[f][0]),o=Math.abs(k-b[f][1]);if(p>0.5){p=1-p}if(o>0.5){o=1-o}if(p*p+o*o<i){a=false;break}}if(a){b.push([l,k]);i=c/b.length}else{i*=0.9}}for(var f=0;f<e;++f){b[f][0]=d+b[f][0]*h;b[f][1]=m+b[f][1]*g}return b};UFX.random.spread1d=function(h,d){h=h||100;d=d||0.15;var g=[],b=1;while(g.length<h){var a=UFX.random(),f=true;for(var e=0;e<g.length;++e){var c=Math.abs(a-g[e]);if(c>0.5){c=1-c}if(c<b){f=false;break}}if(f){g.push(a);b=0.5*d/g.length}else{b*=0.95}}return g};UFX.random.normal=function(c,e){c=c||0;e=e||1;if(typeof UFX.random.normal._y=="number"){var a=UFX.random.normal._y;delete UFX.random.normal._y}else{var a,f,b;do{a=UFX.random(-1,1);f=UFX.random(-1,1);b=a*a+f*f}while(b>1);try{b=Math.sqrt(-2*Math.log(b)/b);a*=b;f*=b}catch(d){a=f=0}UFX.random.normal._y=f}return a*e+c};"use strict";var UFX=UFX||{};UFX.noise=function(d,o){var e=d.length;var c=new Array(e);var s=new Array(e);for(var h=0;h<e;++h){var x=o?o[h]:256;var l=Math.floor(d[h])%x;if(l<0){l+=x}c[h]=[l,(l+1)%x];s[h]=d[h]-Math.floor(d[h])}var b=0;for(var f=0,u=1<<e;f<u;++f){var y=new Array(e);for(var h=0;h<e;++h){y[h]=c[h][(f>>h)&1]}var z=0,B=1;for(var h=0;h<e;++h){var m=UFX.noise._gvalue(y,h);var A=((f>>h)&1)?1-s[h]:-s[h];z+=m*A;B*=1-A*A*(3-2*Math.abs(A))}b+=z*B}return b/1000/Math.sqrt(e)};UFX.noise.wrap2d=function(O,J,U,T){var m=O[0],l=O[1],i=m*l;var F=new Array(i);var z=new Array(m),w=new Array(m);var c=new Array(m),N=new Array(m),I=new Array(m),t=new Array(m);J=J||[8,8];var R=J[0],Q=J[1],S=R*Q;T=T||[0,0];var B=new Array(S),A=new Array(S);for(var d=0,q=0;d<Q;++d){for(var e=0;e<R;++e,++q){B[q]=UFX.noise._gvalue([e+T[0],d+T[1]],0);A[q]=UFX.noise._gvalue([e+T[0],d+T[1]],1)}}U=U||[0,0];for(var k=0;k<m;++k){var M=(k+0.5)*R/m+U[0];z[k]=Math.floor(M)%R;if(z[k]<0){z[k]+=R}w[k]=(z[k]+1)%R;var D=M-Math.floor(M),v=1-D;c[k]=D;N[k]=v;I[k]=D*D*(3-2*D);t[k]=1-I[k]}for(var j=0,u=0;j<l;++j){var L=(j+0.5)*Q/l+U[1];var C=Math.floor(L)%Q;if(C<0){C+=Q}var g=(C+1)%Q;var h=L-Math.floor(L),b=1-h;var P=h*h*(3-2*h),K=1-P;for(var k=0;k<m;++k,++u){var H=z[k],r=w[k];var D=c[k],v=N[k],f=I[k],a=t[k];var G=H+C*R,E=H+g*R;var p=r+C*R,o=r+g*R;F[u]=((-D*B[G]-h*A[G])*K+(-D*B[E]+b*A[E])*P)*a+((v*B[p]-h*A[p])*K+(v*B[o]+b*A[o])*P)*f;F[u]/=1414.213}}return F};UFX.noise.wrapslice=function(W,ad,O,ag,af){var q=W[0],o=W[1],k=q*o;var J=new Array(k);var D=new Array(q),C=new Array(q);var d=new Array(q),U=new Array(q),N=new Array(q),z=new Array(q);O=O||[8,8,256];if(O.length==2){O=[O[0],O[1],256]}var aa=O[0],Z=O[1],Y=O[2],ab=aa*Z;af=af||[0,0];var V=Math.floor(ad)%Y;if(V<0){V+=Y}var T=(V+1)%Y;var c=ad-Math.floor(ad),S=1-c;var L=c*c*(3-2*c),v=1-L;var H=new Array(ab),p=new Array(ab),ae=new Array(ab);var G=new Array(ab),m=new Array(ab),ac=new Array(ab);for(var e=0,u=0;e<Z;++e){for(var f=0;f<aa;++f,++u){H[u]=UFX.noise._gvalue([f+af[0],e+af[1],V],0);p[u]=UFX.noise._gvalue([f+af[0],e+af[1],V],1);ae[u]=UFX.noise._gvalue([f+af[0],e+af[1],V],2);G[u]=UFX.noise._gvalue([f+af[0],e+af[1],T],0);m[u]=UFX.noise._gvalue([f+af[0],e+af[1],T],1);ac[u]=UFX.noise._gvalue([f+af[0],e+af[1],T],2)}}ag=ag||[0,0];for(var l=0;l<q;++l){var R=(l+0.5)*aa/q+ag[0];D[l]=Math.floor(R)%aa;if(D[l]<0){D[l]+=aa}C[l]=(D[l]+1)%aa;var F=R-Math.floor(R),B=1-F;d[l]=F;U[l]=B;N[l]=F*F*(3-2*F);z[l]=1-N[l]}for(var j=0,A=0;j<o;++j){var Q=(j+0.5)*Z/o+ag[1];var E=Math.floor(Q)%Z;if(E<0){E+=Z}var i=(E+1)%Z;var h=Q-Math.floor(Q),b=1-h;var X=h*h*(3-2*h),P=1-X;for(var l=0;l<q;++l,++A){var M=D[l],w=C[l];var F=d[l],B=U[l],g=N[l],a=z[l];var K=M+E*aa,I=M+i*aa;var t=w+E*aa,r=w+i*aa;J[A]=(((-F*H[K]-h*p[K]-c*ae[K])*P+(-F*H[I]+b*p[I]-c*ae[I])*X)*a+((B*H[t]-h*p[t]-c*ae[t])*P+(B*H[r]+b*p[r]-c*ae[r])*X)*g)*v+(((-F*G[K]-h*m[K]+S*ac[K])*P+(-F*G[I]+b*m[I]+S*ac[I])*X)*a+((B*G[t]-h*m[t]+S*ac[t])*P+(B*G[r]+b*m[r]+S*ac[r])*X)*g)*L;J[A]/=1732.051}}return J};UFX.noise.fractalize=function(p,t,r){var n=t[0],i=t[1];var b=n/2,k=i/2,o=b*k;if(b<2||k<2){return}var m=new Array(b*k);for(var g=0,d=0;g<i;g+=2){var e=g*n;for(var l=0;l<n;l+=2,++d){m[d]=p[e+l]}}if(r!==1){UFX.noise.fractalize(m,[b,k],(typeof r=="number"?r-1:r))}for(var d=0;d<o;++d){m[d]*=0.5}for(var f=0,q=0;f<k;++f){for(var a=0;a<b;++a,++q){var c=m[q];p[f*n+a]+=c;p[f*n+a+b]+=c;p[(f+k)*n+a]+=c;p[(f+k)*n+a+b]+=c}}};UFX.noise._grad=[-2885,-2520,-2335,-2206,-2106,-2024,-1953,-1891,-1835,-1785,-1739,-1696,-1656,-1618,-1583,-1550,-1518,-1488,-1459,-1431,-1404,-1378,-1353,-1329,-1306,-1283,-1261,-1240,-1219,-1199,-1179,-1159,-1140,-1122,-1104,-1086,-1068,-1051,-1034,-1018,-1001,-985,-970,-954,-939,-924,-909,-894,-879,-865,-851,-837,-823,-809,-796,-783,-769,-756,-743,-730,-718,-705,-693,-680,-668,-656,-644,-632,-620,-608,-596,-584,-573,-561,-550,-539,-527,-516,-505,-494,-483,-472,-461,-450,-439,-428,-418,-407,-396,-386,-375,-365,-354,-344,-334,-323,-313,-303,-292,-282,-272,-262,-252,-242,-232,-222,-212,-202,-192,-182,-172,-162,-152,-142,-132,-122,-112,-102,-93,-83,-73,-63,-53,-44,-34,-24,-14,-4,4,14,24,34,44,53,63,73,83,93,102,112,122,132,142,152,162,172,182,192,202,212,222,232,242,252,262,272,282,292,303,313,323,334,344,354,365,375,386,396,407,418,428,439,450,461,472,483,494,505,516,527,539,550,561,573,584,596,608,620,632,644,656,668,680,693,705,718,730,743,756,769,783,796,809,823,837,851,865,879,894,909,924,939,954,970,985,1001,1018,1034,1051,1068,1086,1104,1122,1140,1159,1179,1199,1219,1240,1261,1283,1306,1329,1353,1378,1404,1431,1459,1488,1518,1550,1583,1618,1656,1696,1739,1785,1835,1891,1953,2024,2106,2206,2335,2520,2885];UFX.noise._perm=[127,13,214,153,195,181,253,32,17,180,95,9,159,81,209,129,31,157,21,76,118,79,91,0,38,234,8,147,148,227,206,78,22,223,198,109,240,46,115,71,133,175,232,14,168,37,196,49,213,106,62,119,85,61,104,220,139,203,44,73,189,237,39,210,28,57,6,172,164,40,51,186,233,52,204,199,50,243,161,126,249,7,36,244,131,231,24,1,252,142,27,53,188,254,137,184,92,201,136,165,43,145,205,216,33,19,101,75,156,60,228,215,197,185,248,30,26,200,107,96,11,247,173,111,108,235,166,241,105,120,47,110,130,167,112,208,160,154,42,16,48,34,202,221,74,122,236,64,143,246,103,88,222,238,162,155,163,80,230,72,25,176,68,158,121,124,63,177,113,41,3,45,86,55,114,67,134,212,58,242,179,192,35,170,211,15,149,224,140,66,128,219,193,2,229,117,93,54,132,135,218,169,187,207,191,144,138,245,190,65,23,146,123,56,152,194,171,18,4,100,150,255,99,98,183,83,70,97,141,178,182,250,84,10,239,217,94,116,174,29,151,82,12,225,59,125,20,5,69,251,77,102,90,89,226,87];UFX.noise._gvalue=function(a,d){var c=UFX.noise._perm[d];for(var b=0;b<a.length;++b){c=UFX.noise._perm[(c+a[b])&255]}return UFX.noise._grad[c]};"use strict";var UFX=UFX||{};UFX.texture={joinobj:function(d,c){var b=Object.create(c);if(!d){return b}for(var a in d){b[a]=d[a]}return b},reduceargs:function(b){if(b.length==0){return{}}var c=b[0]||{};for(var a=1;a<b.length;++a){if(b[a]){c=this.joinobj(c,b[a])}}return c},makecanvas:function(a,c){var b=document.createElement("canvas");b.width=a;b.height=c;b.context=b.getContext("2d");var d=b.context.createImageData(a,c);b.data=d.data;b.applydata=function(){b.context.putImageData(d,0,0);delete b.data};return b},stat:function(){var f=this.reduceargs(arguments);var o=f.width||f.size||256;var g=f.height||f.size||256;var l=f.rmin||0,q="rmax" in f?f.rmax:256;var i=f.gmin||0,p="gmax" in f?f.gmax:256;var n=f.bmin||0,b="bmax" in f?f.bmax:256;var c=f.wmin||0,m=f.wmax||0;if(f.seed){UFX.random.setseed(f.seed)}var a=this.makecanvas(o,g),e=a.data;for(var d=0;d<o*g*4;d+=4){var k=m&&UFX.random.rand(c,m);e[d]=k+(q&&UFX.random.rand(l,q));e[d+1]=k+(p&&UFX.random.rand(i,p));e[d+2]=k+(b&&UFX.random.rand(n,b));e[d+3]=255}a.applydata();return a},grass:function(){return this.stat(this.reduceargs(arguments),{rmin:20,rmax:60,gmin:100,gmax:140,bmin:0,bmax:20})},deadgrass:function(){return this.stat(this.reduceargs(arguments),{wmin:100,wmax:120,rmin:80,rmax:100,gmin:80,gmax:100,bmin:0,bmax:0})},dirt:function(){return this.stat(this.reduceargs(arguments),{rmin:90,rmax:120,gmin:90,gmax:120,bmin:0,bmax:10})},gravel:function(){return this.stat(this.reduceargs(arguments),{wmin:60,wmax:200,rmin:0,rmax:10,gmin:0,gmax:10,bmin:0,bmax:10})},spots:function(){var s=this.reduceargs(arguments);var p=s.width||s.size||256;var B=s.height||s.size||256;var v=s.rmin||0,z=s.rmax||256;var a=s.gmin||0,c=s.gmax||256;var i=s.bmin||0,l=s.bmax||256;var n=s.wmin||0,q=s.wmax||0;var t=10000;if(s.seed){UFX.random.setseed(s.seed)}var e=document.createElement("canvas");e.width=p;e.height=B;var d=e.getContext("2d");d.globalAlpha=s.alpha||0.1;for(var A=0;A<t;++A){var k=q&&UFX.random.rand(n,q);var u=k+UFX.random.rand(v,z);var C=k+UFX.random.rand(a,c);var D=k+UFX.random.rand(i,l);var o=UFX.random(p),m=UFX.random(B);var f=20;d.fillStyle="rgb("+u+","+C+","+D+")";d.beginPath();d.arc(o,m,f,0,2*Math.PI);d.fill()}return e},noisedata:function(){var d=this.reduceargs(arguments);var k=d.width||d.size||256;var f=d.height||d.size||256;var b=d.xscale||d.scale||8;var c=d.yscale||d.scale||8;var j=d.fraclevel||0;if(d.seed){UFX.random.setseed(d.seed)}var i=256;var g=("xoffset" in d)?d.xoffset:UFX.random(b);var a=("yoffset" in d)?d.yoffset:UFX.random(c);var e=("zoffset" in d)?d.zoffset:UFX.random(i);var l=UFX.noise.wrapslice([k,f],e,[b,c,i],[g,a]);if(j){UFX.noise.fractalize(l,[k,f],j)}return l},roughshade:function(){var l=this.reduceargs(arguments);var f=l.width||l.size||256;var s=l.height||l.size||256;var o=l.color||[0,0,0];var n=l.alpha0||100;var u=l.ascale||50;var m=o[0],t=o[1],z=o[2];var a=this.makecanvas(f,s),A=a.data;var v=this.noisedata(l,{scale:64});for(var c=0,q=0,p=0;c<s;++c){for(var d=0;d<f;++d,q+=4,++p){var i=v[c*f+(d+1)%f]-v[c*f+(d+f-1)%f];var e=v[(c+1)%s*f+d]-v[(c+s-1)%s*f+d];A[q]=m;A[q+1]=t;A[q+2]=z;A[q+3]=n+u*(2*i+e)}}a.applydata();return a},stone:function(){var e=this.reduceargs(arguments);var i=e.width||e.size||256;var g=e.height||e.size||256;var c=e.color||[120,120,120];var a=this.makecanvas(i,g),f=a.data;var m=this.noisedata(e);for(var d=0,b=0;b<i*g;d+=4,++b){var l=150;l+=Math.max(Math.min(1000*(m[b]),30),-30);l+=Math.max(100-8000*Math.abs(m[b]),0);f[d]=l*c[0]/255;f[d+1]=l*c[1]/255;f[d+2]=l*c[2]/255;f[d+3]=255}a.applydata();return a},terrain:function(){var p=this.reduceargs(arguments);var m=p.width||p.size||256;var B=p.height||p.size||256;var F=p.tgrad||[[-1,0,0,192],[-0.35,0,0,255],[-0.1,0,128,255],[-0.04,240,240,64],[0.08,32,160,0],[0.35,160,160,0],[0.5,128,128,128],[0.7,255,255,255]],c=F.length;var A="sealevel" in p?p.sealevel:-0.1;var q=p.shadecolor||[0,0,0];var t=q[0],I=q[1],b=q[2];var H=p.shadex||0,G=p.shadey||0;var z=(H||G)&&2*Math.exp(p.shadefactor||0)/Math.sqrt(H*H+G*G);var d=this.makecanvas(m,B),J=d.data;var E=this.noisedata(p,{fraclevel:3,scale:8});function a(w){if(w<=F[0][0]){return[F[0][1],F[0][2],F[0][3]]}for(var x=0;x<c-1;++x){var k=F[x],h=F[x+1];if(w>=k[0]&&w<h[0]){var K=(w-k[0])/(h[0]-k[0]),y=1-K;return[h[1]*K+k[1]*y,h[2]*K+k[2]*y,h[3]*K+k[3]*y]}}return[F[c-1][1],F[c-1][2],F[c-1][3]]}for(var e=0,u=0,s=0;e<B;++e){for(var i=0;i<m;++i,u+=4,++s){var o=E[s];var r=a(o);if(z&&o>A){var n=E[e*m+(i+1)%m]-E[e*m+(i+m-1)%m];var l=E[(e+1)%B*m+i]-E[(e+B-1)%B*m+i];var D=1+(H*n+G*l)*z,C=1-D;r[0]=D*r[0]+C*z;r[1]=D*r[1]+C*z;r[2]=D*r[2]+C*z}J[u]=r[0];J[u+1]=r[1];J[u+2]=r[2];J[u+3]=255}}d.applydata();return d},clouds:function(){var p=this.reduceargs(arguments);var o=p.width||p.size||256;var C=p.height||p.size||256;var v=p.color||[200,200,200];var s=v[0],D=v[1],J=v[2];var q=p.sharpness||0;var i=(p.coverage||0.4)-0.5;var t=p.shadecolor||[0,0,0];var z=t[0],M=t[1],c=t[2];var I=p.shadex||0,H=p.shadey||0;var B=(I||H)&&0.002*Math.exp(p.shadefactor||0)/Math.sqrt(I*I+H*H);var l=4000*Math.exp(q);var e=this.makecanvas(o,C),N=e.data;var F=this.noisedata(p,{fraclevel:2});for(var m=0,A=0,u=0;m<C;++m){for(var n=0;n<o;++n,A+=4,++u){var K=(F[u]+i)*l+128;N[A+3]=K;if(B){var L=(F[((n+I)%o)+((m+H)%C)*o]+i)*l+128;var E=Math.min(Math.max(B*(K-L),0),1);var G=1-E;N[A]=s*G+z*E;N[A+1]=D*G+M*E;N[A+2]=J*G+c*E}else{N[A]=s;N[A+1]=D;N[A+2]=J}}}e.applydata();return e},overcast:function(){var i=this.reduceargs(arguments);var o=i.width||i.size||256;var l=i.height||i.size||256;var d="r0" in i?i.r0:160,c="dr" in i?i.dr:80;var a="g0" in i?i.g0:160,m="dg" in i?i.dg:80;var n="b0" in i?i.b0:160,r="db" in i?i.db:80;var b=this.makecanvas(o,l),g=b.data;var q=this.noisedata(i,{fraclevel:2,scale:8});for(var f=0,e=0;e<o*l;f+=4,++e){var p=q[e];g[f]=d+p*c;g[f+1]=a+p*m;g[f+2]=n+p*r;g[f+3]=255}b.applydata();return b},ocean:function(){return this.overcast(this.reduceargs(arguments),{r0:40,dr:30,g0:40,dg:30,b0:160,db:60})},marble:function(){var n=this.reduceargs(arguments);var i=n.width||n.size||256;var s=n.height||n.size||256;var e="xfactor" in n?n.xfactor:1;var t="yfactor" in n?n.yfactor:2;var c=(n.coverage||1.5)-0.5;var b=3*Math.exp(n.distortion||0);var o=Math.min(30*Math.exp(n.cloudiness||0),250),z=255-o;var l=1000*Math.exp(n.sharpness||0);var d=this.makecanvas(i,s),A=d.data;var u=this.noisedata(n,{fraclevel:3,scale:8});var p=2*Math.PI*e/i;var a=2*Math.PI*t/s;for(var f=0,r=0,q=0;f<s;++f){for(var g=0;g<i;++g,r+=4,++q){var m=u[q];m=Math.abs(Math.sin(b*m+p*g+a*f));m=Math.min(m*l,z)+m*o;A[r]=m;A[r+1]=m;A[r+2]=m;A[r+3]=255}}d.applydata();return d},nightsky:function(){var d=this.reduceargs(arguments);var b=this.overcast(d,{r0:0,dr:0,g0:0,dg:10,b0:20,db:20});var i=b.width,e=b.height;var j=Math.floor(("density" in d?d.density:1)*i*e/500);var f="spread" in d?d.spread:0.15;var a="rstar0" in d?d.rstar0:0;var k="rstar1" in d?d.rstar1:0.8;var g=b.context;g.beginPath();UFX.random.spread(j,f).forEach(function(h){var c=h[0]*i,l=h[1]*e;g.moveTo(c,l);g.arc(c,l,UFX.random(a,k),0,2*Math.PI)});g.fillStyle="white";g.fill();return b},noisestat:function(){var n=this.reduceargs(arguments);var i=n.width||n.size||256;var u=n.height||n.size||256;var q=n.rmin||0,t="rmax" in n?n.rmax:256;var a=n.gmin||0,b="gmax" in n?n.gmax:256;var d=n.bmin||0,f="bmax" in n?n.bmax:256;var g=n.wmin||0,m=n.wmax||0;var p="dr" in n?n.dr:0;var y="dg" in n?n.dg:0;var z="db" in n?n.db:0;var o="dw" in n?n.dw:0;if(n.seed){UFX.random.setseed(n.seed)}var x=this.noisedata(n);var c=this.makecanvas(i,u),A=c.data;for(var s=0,r=0;r<i*u;s+=4,++r){var e=m&&UFX.random.rand(g,m)+l*o;var l=x[r];A[s]=e+(t&&UFX.random.rand(q,t))+l*p;A[s+1]=e+(b&&UFX.random.rand(a,b))+l*y;A[s+2]=e+(f&&UFX.random.rand(d,f))+l*z;A[s+3]=255}c.applydata();return c},patchygrass:function(){return this.noisestat(this.reduceargs(arguments),{wmin:40,wmax:80,dw:-40,rmin:0,rmax:20,dr:-40,gmin:60,gmax:90,dg:40,bmin:0,bmax:10})},patchydirt:function(){return this.noisestat(this.reduceargs(arguments),{wmin:40,wmax:80,dw:-20,rmin:60,rmax:80,dr:60,gmin:20,gmax:40,dg:80,bmin:0,bmax:4})},cement:function(){return this.noisestat(this.reduceargs(arguments),{wmin:120,wmax:160,dw:40,rmin:0,rmax:10,gmin:0,gmax:10,bmin:0,bmax:10})},buffertile:function(g,f){var c=f||20,e=g.width,j=g.height;var i=document.createElement("canvas");i.width=e+2*c;i.height=j+2*c;i.context=i.getContext("2d");for(var d=-1;d<2;++d){for(var a=-1;a<2;++a){i.context.drawImage(g,c+e*d,c+j*a)}}i.drawclip=function(h,b,k){h.save();h.translate(b||0,k||0);h.beginPath();h.moveTo(0,0);h.lineTo(e+0.01,0);h.lineTo(e+0.01,j+0.01);h.lineTo(0,j+0.01);h.closePath();h.clip();h.drawImage(i,-c,-c);h.restore()};return i}};UFX.texture.tiler=function(b,a,c,d){if(!(this instanceof UFX.texture.tiler)){return new UFX.texture.tiler(b,a,c,d)}this.canvas=b;this.buffer=a||2;this.nx=this.ny=0;this.makechart(c||1,d||1)};UFX.texture.tiler.prototype={draw:function(c,l,i,n,g){if(n===undefined){n=l;g=i;l=0;i=0}var j=this.buffer,f=this.canvas.width,e=this.canvas.height;var d=((l-j)%f+f)%f+j,a=d+n;var m=((i-j)%e+e)%e+j,k=m+g;this.makechart(Math.floor((a+j)/f)+1,Math.floor((k+j)/e)+1);c.save();c.translate(l||0,i||0);c.beginPath();c.moveTo(0,0);c.lineTo(n,0);c.lineTo(n,g);c.lineTo(0,g);c.closePath();c.clip();c.drawImage(this.chart,-d,-m);c.restore()},makechart:function(a,e){if(a<=this.nx&&e<=this.ny){return}this.nx=Math.max(a,this.nx);this.ny=Math.max(e,this.ny);this.chart=document.createElement("canvas");this.chart.width=this.canvas.width*this.nx;this.chart.height=this.canvas.height*this.ny;var d=this.chart.getContext("2d");for(var c=0;c<this.nx;++c){for(var b=0;b<this.ny;++b){d.drawImage(this.canvas,c*this.canvas.width,b*this.canvas.height)}}}};"use strict";var UFX=UFX||{};UFX.Thing=function(){var b=Object.create(UFX.Thing.prototype);for(var a=0;a<arguments.length;++a){b.addcomp(arguments[a])}return b};UFX.Thing.prototype={_createmethod:function(c,d,a){a=a||[];var b;if(!d){b=function(){var f;for(var e=0;e<a.length;++e){f=a[e].apply(this,arguments)}return f}}else{if(d==="any"){b=function(){var f;for(var e=0;e<a.length;++e){f=a[e].apply(this,arguments);if(f){return f}}return f}}else{if(d==="all"){b=function(){var f;for(var e=0;e<a.length;++e){f=a[e].apply(this,arguments);if(!f){return f}}return f}}else{if(d==="getarray"){b=function(){var f=[];for(var e=0;e<a.length;++e){f.push(a[e].apply(this,arguments))}return f}}else{if(d==="putarray"){b=function(e){var g=[];for(var f=0;f<a.length;++f){g.push(a[f].apply(this,e[f]))}return g}}else{}}}}}b.mlist=a;return b},definemethod:function(a,b){if(this[a]){return this}this[a]=this._createmethod(a,b);return this},addcomp:function(a){if(a instanceof Array){var d=a.slice(0);for(var b=0;b<d.length;++b){arguments[0]=d[b];this.addcomp.apply(this,arguments)}return this}for(var c in a){if(c=="init"||c=="remove"){continue}if(typeof a[c]!="function"){continue}this.definemethod(c);this[c].mlist.push(a[c])}if(a.init){a.init.apply(this,[].slice.call(arguments,1))}return this},removecomp:function(a){if(a instanceof Array){var d=a.slice(0);for(var b=0;b<d.length;++b){arguments[0]=d[b];this.removecomp.apply(this,arguments)}return this}if(a.remove){a.remove.apply(this,[].slice.call(arguments,1))}for(var c in a){if(c=="init"||c=="remove"){continue}if(!(c in this)){continue}this[c].mlist=this[c].mlist.filter(function(e){return e!==a[c]})}return this},reversemethods:function(a){this[a].mlist.reverse();return this},setmethodmode:function(a,b){this[a]=this._createmethod(a,b,(this[a]?this[a].mlist:[]));return this},normalize:function(){for(mname in this){if(this.hasOwnProperty(mname)&&this[mname].mlist&&this[mname].mlist.length==1){this[mname]=this[mname].mlist[0]}}}};UFX.Component={};UFX.Component.HasChildren={init:function(){this.children=[]},nchildren:function(){return this.children.length},_addchild:function(a){this.children.push(a);return this},_removechild:function(a){this.children=this.children.filter(function(b){return b!==a});return this},lastchild:function(){return this.children[this.children.length-1]},die:function(){for(var a=0;a<this.children.length;++a){this.children[a].die()}},think:function(){for(var a=0;a<this.children.length;++a){this.children[a].think.apply(this.children[a],arguments)}},draw:function(b){for(var a=0;a<this.children.length;++a){b.save();this.children[a].draw(b);b.restore()}}};UFX.Component.SortChildren={init:function(a){this.childsortfunc=a||function(d,c){return d.z-c.z}},addchild:function(a){this.children.sort(this.childsortfunc)}};UFX.Component.HasParent={init:function(a){this.attachto(a)},attachto:function(a){if(this.parent){this.parent._removechild(this)}this.parent=a;if(this.parent){this.parent._addchild(this)}return this},detach:function(){return this.attachto()},die:function(){return this.detach()}};UFX.scenes.play={start:function(){state.init();this.mode="play";this.buildoff=[0,0];this.vplatform=new VirtualPlatform(0,0,settings.psize);var a=UFX.texture.stone({size:512,scale:16});a.context.drawImage(UFX.texture.roughshade({size:512}),0,0);this.backdrop=document.createElement("canvas");this.backdrop.width=this.backdrop.height=512;UFX.draw(this.backdrop.getContext("2d"),"[ drawimage0",a,"] fs rgba(0,0,0,0.5) f0");camera.focus=state.you;camera.think(1);playmusic("song"+state.njump)},thinkargs:function(a){return[a,UFX.key.state()]},think:function(e,a){if(this.mode=="play"){if(a.down.up&&state.you.kjump<state.njump){state.you.leap()}if(state.you.hanging&&!a.pressed.up){state.you.hanging=0}if(state.you.parent&&a.down.down){state.you.drop()}state.you.hmove((a.pressed.right?1:0)-(a.pressed.left?1:0));if(a.down.space){if(state.nearhouse(state.you)){state.talk(state.nearhouse(state.you))}else{if(state.canbuild){this.mode="build";this.vplatform.x=Math.floor(state.you.x)+this.buildoff[0];this.vplatform.y=Math.floor(state.you.y)+this.buildoff[1]}}}if(state.canwarp&&a.down.tab){while(true){var d=UFX.random.choice(Object.keys(HouseNames));if(!state.done["know"+d]||!state.done["rescue"+d]){continue}if(state.you.parent&&state.you.parent.house&&state.you.parent.house.name==d){continue}state.lastlanding=state.houses[d].parent;state.resetfall();playsound("warp");break}}if(DEBUG&&a.down.F4&&state.you.parent){state.removeplatform(state.you.parent);state.you.drop()}if(DEBUG&&a.down.F5){this.vplatform.dx=settings.psize-=1}if(DEBUG&&a.down.F6){this.vplatform.dx=settings.psize+=1}if(DEBUG&&a.down.F7&&state.you.parent){state.you.parent.ischeck=!state.you.parent.ischeck}if(DEBUG&&a.down.F11){state.dump()}if(DEBUG&&a.down.F9){state.sun=true;state.canwarp=true;state.canbuild=true;for(d in HouseNames){state.done["know"+d]=true}for(d in HouseNames){state.done["rescue"+d]=true}state.njump=3;state.jhang=3}if(DEBUG&&a.down.F2){makeworldmap()}}else{if(this.mode=="build"){if(a.down.left){this.buildoff[0]-=1}if(a.down.right){this.buildoff[0]+=1}if(a.down.up){this.buildoff[1]+=1}if(a.down.down){this.buildoff[1]-=1}this.vplatform.x=Math.floor(state.you.x)+this.buildoff[0];this.vplatform.y=Math.floor(state.you.y)+this.buildoff[1];if(!a.pressed.space){if(state.canplace(this.vplatform)){var f=new Platform(this.vplatform.x,this.vplatform.y,this.vplatform.dx);state.platforms.push(f);state.newplatforms.push(f);state.sortplatforms();state.gp-=settings.pcost}this.mode="play"}}else{if(this.mode=="fly"){if(a.down.left){state.you.x-=1}if(a.down.right){state.you.x+=1}if(a.down.up){state.you.y+=1}if(a.down.down){state.you.y-=1}if(a.down.np4){state.you.x-=5}if(a.down.np6){state.you.x+=5}if(a.down.np2){state.you.y-=5}if(a.down.np8){state.you.y+=5}}}}if(DEBUG&&a.down.F3){this.mode=this.mode=="fly"?"play":"fly"}if(this.mode=="fly"){state.you.think(0);state.you.parent=null}else{state.you.think(e);if(!state.you.parent&&state.you.vy<0){state.forplatforms(state.you.y-1,state.you.oldy+1,function(h){if(h.catches(state.you)){state.you.land(h)}})}if(state.you.y<state.lastlanding.y-settings.maxfall){state.you.takedamage(1);state.resetfall()}var c=state.you.x,b=state.you.y+0.3,g=0.2;state.effects=state.effects.filter(function(i,h){i.think(e);return i.alive});state.splats=state.splats.filter(function(i,h){i.think(e);return i.alive});state.monsters=state.monsters.filter(function(h){if(!h.alive){return false}h.think(e);if(h.hits(c,b,g)){if(!state.you.tmercy){state.you.takedamage(1)}}return true})}if(this.mode=="build"){this.vplatform.think(e)}camera.think(e);state.checksectors();if(state.you.hp<=0){UFX.scene.swap("death")}},draw:function(){var F=-camera.x0*camera.z/2,e=camera.y0*camera.z/2;UFX.draw("fs #600 f0 [ t",F,e);var w=Math.floor(-F/512),v=1+Math.floor((-F+canvas.width)/512);var d=Math.floor(-e/512),b=1+Math.floor((-e+canvas.height)/512);for(var A=w;A<v;++A){for(var y=d;y<b;++y){UFX.draw("drawimage",this.backdrop,512*A,512*y)}}UFX.draw("]");if(state.you.y>140){var f=Math.min(Math.max((state.you.y-140)/20,0),1);UFX.draw("fs rgba(220,220,255,"+f+") f0")}context.save();camera.transform();function n(c){if(!camera.visible(c.x,c.y,c.r||0.5)){return}context.save();c.draw();context.restore()}state.forplatforms(camera.ymin,camera.ymax,n);state.buildings.forEach(n);state.monsters.forEach(n);n(state.you);if(this.mode=="build"){n(this.vplatform)}state.effects.forEach(n);state.splats.forEach(n);context.restore();if(!state.sun){var l=canvas.width/2,x=canvas.height/2,u=settings.rmask*camera.z;var B=UFX.random(0.5,0.52);var z=UFX.random(0.7,0.72);var G=state.you.tmercy?Math.floor(128*state.you.tmercy/settings.tmercy):0;var g=UFX.draw.radgrad(l,x,0,l,x,u,0,"rgba("+G+",0,0,0.5)",B,"rgba("+G+",0,0,0.5)",z,"rgba("+G+",0,0,0.55)",1,"rgba("+G+",0,0,1)");UFX.draw("fs",g,"f0")}var E=0.4*Math.min(canvas.width,canvas.height)/camera.z;UFX.draw("[ t",canvas.width/2,canvas.height/2,"z",0.01*camera.z,0.01*camera.z);for(var C in state.houses){if(!state.done["know"+C]){continue}var m=state.houses[C];var p=m.x-camera.x0,o=m.y-camera.y0;var u=Math.sqrt(p*p+o*o),s=u/E;if(s<1){continue}var k=Math.atan2(-p,-o);UFX.draw("[ r",k,"t 0",100*E,"( m 0 200 l -50 0 l 50 0 ) fs #006 f ss #666 lw 5 s","t 0 -50 r",-k,"fs white ss black textalign center font 60px~'Pirata~One' sh black 2 2 0 ft0",HouseNames[C],"]")}UFX.draw("]");if(state.nearhouse(state.you)){var q="House~of~"+HouseNames[state.nearhouse(state.you).name]+"~(Space:~talk)";UFX.draw("fs white font 22px~'Sansita~One' textalign center","[ t",canvas.width/2,canvas.height*0.7,"ft0",q,"]")}var a=[];a.push("Depth: "+(170-Math.floor(state.you.y))+" fathoms");a.push("Health: "+state.you.hp+"/"+state.you.maxhp);if(state.jhang){a.push("GP: "+(state.gp>100000?"unlimited":state.gp))}a.push("Left/right or A/D: move");a.push("Down or S: drop");if(state.jhang){a.push("Up or W: Slash (hold to glide)")}else{a.push("Up or W: Jump")}if(state.canbuild){a.push("Hold Space + use arrows: Build (cost "+settings.pcost+"GP)")}if(state.canwarp){a.push("Tab: warp to random House.")}if(DEBUG){a=a.concat([UFX.ticker.getrates(),"pos: "+Math.floor(state.you.x)+", "+Math.floor(state.you.y),"F3: toggle fly mode","F4: destroy parent","F5/F6: adjust psize "+settings.psize,"F7: toggle checkpoint","F11: dump state"])}var C=Math.floor(canvas.height/30);UFX.draw("fs white textalign left font",C+"px~'Sansita~One'");a.forEach(function(h,c){UFX.draw("[ t 4",C*1.3*(c+1),"ft0",h.replace(/ /g,"~"),"]")});if(this.mode=="build"&&state.gp<settings.pcost){UFX.draw("[ t",canvas.width/2,canvas.height*0.2,"textalign center font",C+"px~'Sansita~One' fs red ss black lw 1","fst0 platforms~require~"+settings.pcost+"gp ]")}else{if(this.mode=="build"&&this.vplatform.y>110){UFX.draw("[ t",canvas.width/2,canvas.height*0.2,"textalign center font",C+"px~'Sansita~One' fs red ss black lw 1","fst0 platforms~cannot~be~built~above~60~fathoms ]")}}}};function makeworldmap(){console.log("world map time");var c=canvas,b=context;canvas=document.createElement("canvas");context=canvas.getContext("2d");UFX.draw.setcontext(context);canvas.width=canvas.height=1600;camera.x0=0;camera.y0=40;camera.z=4;UFX.draw("fs black f0");context.save();camera.transform();for(var d=-210;d<200;d+=20){UFX.draw("lw 20 ss #222 b m -20000",100*d,"l 20000",100*d,"s");UFX.draw("[ fs #444 font 400px~'Sansita~One' t -15000",100*d,"vflip ft0",(170-d)+"~fathoms ]")}function a(e){context.save();e.draw();context.restore()}state.platforms.forEach(a);state.buildings.forEach(a);state.buildings.forEach(function(e){UFX.draw("[ t",100*e.x,100*(e.y+3),"fs #AAA font 600px~'Pirata~One' vflip textalign center ft0",HouseNames[e.name],"]")});context.restore();window.open(canvas.toDataURL());canvas=c;context=b;UFX.draw.setcontext(context)}var state={init:function(){this.effects=[];this.splats=[];this.buildings=[];this.houses={};this.taken={};this.platforms=[];this.newplatforms=[];this.hsectors={};this.addhouse(0,0,"elgo");this.addhouse(-2,1,"wari");this.addhouse(3,1,"semt");this.addhouse(-3,3,"pald");this.addhouse(0,5,"lume");this.addhouse(2,3,"lige");this.addhouse(-3,-4,"sank");this.addhouse(-6,4,"mian");this.addhouse(3,8,"sarf");this.load(UFX.resource.data.gamedata);this.you=new You(this.houses.elgo.x,this.houses.elgo.y+4);this.sortplatforms();this.monsters=[];this.basesector=null;this.filledsectors={};this.njump=1;this.jhang=0;this.canbuild=false;this.canwarp=false;this.sun=false;this.gp=0;this.builddepth=110;this.lastlanding=this.houses.elgo.parent;this.done={knowelgo:true,rescueelgo:true,rescuewari:true,rescuesarf:true};this.bosses={semt:[],pald:[],lume:[],lige:[],sank:[],mian:[]};this.loadgame()},resetfall:function(){this.you.x=this.lastlanding.x+this.lastlanding.dx*0.5;this.you.y=this.lastlanding.y+0.8;this.you.kjump=999;this.you.drop()},addhouse:function(g,e,b){var a=(g+0.5)*settings.sectorsize,f=(e+0.5)*settings.sectorsize;var d=new Platform(a-4,f,8);var c=new House(a,f,b);c.parent=d;d.house=c;this.buildings.push(c);this.platforms.push(d);this.houses[b]=c;this.hsectors[g+","+e]=c},nearhouse:function(a){if(!a.parent){return false}if(!a.parent.house){return false}if(Math.abs(a.x-a.parent.house.x)>2){return false}if(!this.done["rescue"+a.parent.house.name]){return false}return a.parent.house},talk:function(a){content["talk"+a.name]();this.you.hp=this.you.maxhp;this.gp=Math.max(this.gp,settings.housegp);this.savegame()},sortplatforms:function(){this.platforms.sort(function(b,a){return b.y-a.y})},claimtiles:function(a){var c=a.y;this.taken[c]=this.taken[c]||{};for(var b=0;b<a.dx;++b){this.taken[c][a.x+b]=1}},removeplatform:function(a){this.platforms=this.platforms.filter(function(c){return c!==a});this.taken={};for(var b=0;b<this.platforms.length;++b){this.claimtiles(this.platforms[b])}},canplace:function(a){var c=a.y;if(c>this.builddepth){return false}if(this.gp<settings.pcost){return false}if(!this.taken[c]){return true}for(var b=0;b<a.dx;++b){if(this.taken[c][a.x+b]){return false}}return true},fillsector:function(i,g){var l=settings.sectorsize;var d=this.hsectors[i+","+g];if(d){if(this.done["rescue"+d.name]){return}var f=d.x,e=d.y+1;this.bosses[d.name]=[];if(d.name=="semt"){for(var a=0;a<9;++a){this.bosses[d.name].push(new Lance(f,e,a/9))}}else{if(d.name=="pald"){for(var a=0;a<11;++a){this.bosses[d.name].push(new Wilson(f,e,a/11))}}else{if(d.name=="lume"){for(var a=0;a<10;++a){this.bosses[d.name].push(new Percy(f,e))}}else{if(d.name=="lige"){for(var a=0;a<9;++a){this.bosses[d.name].push(new Lance(f,e,a/9));this.bosses[d.name].push(new Percy(f,e))}}else{if(d.name=="mian"){for(var a=0;a<11;++a){this.bosses[d.name].push(new Wilson(f,e,a/11));this.bosses[d.name].push(new Percy(f,e))}}else{if(d.name=="sank"){for(var a=0;a<11;++a){this.bosses[d.name].push(new Wilson(f,e,a/11));this.bosses[d.name].push(new Lance(f,e,a/11))}}}}}}}}else{if(g<8){var b=16;var c=2*Math.max(this.you.maxhp-3,0);var k=4*Math.max(this.you.maxhp-5,0);UFX.random.spread(200).forEach(function(j){var h=UFX.random(200);h-=b;if(h<0){new Bat(l*(i+j[0]),l*(g+j[1]));return}h-=c;if(h<0){new Zat(l*(i+j[0]),l*(g+j[1]));return}h-=k;if(h<0){new Wat(l*(i+j[0]),l*(g+j[1]));return}})}}},clearsector:function(a){this.monsters=this.monsters.filter(function(b){return b.sectorkey!=a})},checksectors:function(){var a=Math.floor(this.you.x/settings.sectorsize);var f=Math.floor(this.you.y/settings.sectorsize);var e=a+","+f;if(this.basesector==e){return}var b={};for(var i=-1;i<=1;++i){for(var h=-1;h<=1;++h){var d=a+i,c=f+h,g=d+","+c;if(!this.filledsectors[g]){this.fillsector(d,c)}b[g]=1}}for(var g in this.filledsectors){if(!b[g]){this.clearsector(g)}}this.basesector=e;this.filledsectors=b;console.log(this.monsters.length)},forplatforms:function(e,d,f){var b=0,a=this.platforms.length;while(b+1<a){var c=Math.floor((b+a)/2);if(this.platforms[c].y>e){a=c}else{b=c}}for(;b<this.platforms.length&&this.platforms[b].y<=d;++b){f(this.platforms[b])}},checkbosses:function(){for(var a in this.bosses){if(this.done["rescue"+a]){continue}if(this.bosses[a].length&&!this.bosses[a].some(function(c){return c.alive})){delete this.bosses[a];this.done["rescue"+a]=true;playsound("defeat");this.savegame();console.log("saved",a)}}},dump:function(){var b=this.platforms.filter(function(c){return !c.house}).map(function(c){return[c.x,c.y,c.dx,c.ischeck?1:0]});var a={pdata:b};window.open("data:text/json,"+JSON.stringify(a))},load:function(d){for(var b=0;b<d.pdata.length;++b){var c=d.pdata[b];var a=new Platform(c[0],c[1],c[2]);if(c[3]){a.ischeck=true}this.platforms.push(a)}},gamename:"adastrasave",savegame:function(){console.log("saving");var b=this.newplatforms.map(function(c){return[c.x,c.y,c.dx]});var a={youpos:[this.you.x,this.you.y],maxhp:this.you.maxhp,done:this.done,njump:this.njump,jhang:this.jhang,canbuild:this.canbuild,canwarp:this.canwarp,gp:this.gp,pdata:b,sun:this.sun};localStorage[this.gamename]=JSON.stringify(a)},loadgame:function(){if(!localStorage[this.gamename]){return null}var d=JSON.parse(localStorage[this.gamename]);this.you.x=d.youpos[0];this.you.y=d.youpos[1]+0.4;this.you.hp=this.you.maxhp=d.maxhp;this.you.drop();this.done=d.done;this.njump=d.njump;this.jhang=d.jhang;this.canbuild=d.canbuild;this.canwarp=d.canwarp;this.gp=d.gp;this.sun=d.sun;for(var b=0;b<d.pdata.length;++b){var c=d.pdata[b];var a=new Platform(c[0],c[1],c[2]);console.log(a);this.platforms.push(a);this.newplatforms.push(a)}this.sortplatforms()}};var WorldBound={setpos:function(a,b){this.x=a;this.y=b},draw:function(){UFX.draw("t",this.x*100,this.y*100)}};var Stands={think:function(c){if(this.parent){if(!this.parent.supports(this)){this.drop();this.kjump=1;this.y+=0.002}}else{if(this.upward){var e=Math.min(settings.vyup*c,this.dup);this.y+=e;this.dup-=e;if(this.dup==0){this.drop()}}else{if(this.hover){this.hover=Math.max(this.hover-c,0)}else{this.oldy=this.y;if(this.hanging){var b=-settings.ahang;this.hanging=Math.max(this.hanging-c,0)}else{var b=this.ay}this.y+=c*this.vy+0.5*c*c*b;this.vy+=c*b}}}},drop:function(){this.upward=false;this.hover=settings.hover;this.y-=0.001;this.vy=0;this.ay=-settings.aydown;this.parent=null},land:function(a){this.kjump=0;this.parent=a;this.y=this.parent.y;this.vy=0;this.upward=false;this.hover=false}};var HasHealth={init:function(a){this.maxhp=a||1;this.alive=true},heal:function(a){if(a===undefined){this.hp=this.maxhp}else{this.hp=Math.min(this.hp+a,this.maxhp)}},takedamage:function(a){if(this.hp<=0){return}this.hp=Math.max(this.hp-a,0);if(this.hp<=0){this.die()}},die:function(){this.alive=false}};var SplatsOnDeath={takedamage:function(){new Splat(this.x,this.y,1)}};var GivesMoney={init:function(a){this.amt=a||1},die:function(){playsound("pickup");state.gp+=this.amt}};var MercyInvulnerable={takedamage:function(){this.tmercy=settings.tmercy},think:function(a){this.tmercy=Math.max(this.tmercy-a,0)},draw:function(){if(!this.tmercy){return}UFX.draw("alpha",this.tmercy*20%2>=1?0.1:0.9)}};var MovesHorizontal={hmove:function(a){this.vx=(a||0)*settings.vx},think:function(a){this.x+=this.vx*a}};var IsSurface={supports:function(a){return a.x>=this.x&&a.x<=this.x+this.dx},catches:function(a){return a.y<this.y&&a.oldy>=this.y&&this.supports(a)}};var MultiLeaper={leap:function(){playsound("jump");this.kjump+=1;this.parent=null;this.upward=true;this.dup=settings.dup;this.hanging=settings.hangtimes[state.jhang];if(state.jhang>0){new Slash(this.x,this.y+0.3,settings.slashsizes[state.jhang])}}};var DrawLine={init:function(a){this.color=a||"white"},draw:function(){var a=this.ischeck?"yellow":this.color;UFX.draw("ss",a,"lw 8 b m 0 0 l",this.dx*100,"0 s")}};var DrawDebugLine={init:function(a){this.color=a||"white"},draw:function(){if(!DEBUG){return}var a=this.ischeck?"yellow":this.color;UFX.draw("ss",a,"lw 8 b m 0 0 l",this.dx*100,"0 s")}};var DrawPlacable={think:function(a){this.color=state.canplace(this)?"white":"red"}};var FliesLissajous={init:function(d,b,c,a){this.dx=d||3;this.dy=b||1;this.omegax=c||1.1;this.omegay=a||1.6},settrack:function(a,b){this.tfly=0;this.x0=a;this.y0=b},think:function(a){this.tfly+=a;this.x=this.x0+this.dx*Math.sin(this.tfly*this.omegax);this.y=this.y0+this.dy*Math.sin(this.tfly*this.omegay)}};var LissajousPulses={init:function(){this.tpulse=0;this.dx0=this.dx;this.dy0=this.dy},think:function(a){this.tpulse+=a;this.dx=(1+0.4*Math.sin(2*this.tpulse))*this.dx0;this.dy=(1+0.4*Math.cos(2*this.tpulse))*this.dy0}};var FliesToroidal={init:function(a,c,b,d){this.r0=a||1;this.dr=c||0.8;this.omegar=b||5;this.omegap=d||1},settrack:function(a,b){this.tfly=0;this.x0=a;this.y0=b},think:function(c){this.tfly+=c;var b=this.r0+this.dr*Math.sin(this.tfly*this.omegar);var a=this.tfly*this.omegap;this.x=this.x0+2*b*Math.sin(a);this.y=this.y0+0.6*b*Math.cos(a)}};var FliesErratic={init:function(c,a,b){this.dx=c||1;this.dy=a||1;this.v=b||3},settrack:function(a,b){this.tfly=0;this.x0=a;this.y0=b;this.x=this.x0;this.y=this.y0},think:function(c){this.tfly+=c;if(!this.target){this.target=[this.x0+this.dx*UFX.random(-1,1),this.y0+this.dy*UFX.random(-1,1)]}var b=this.target[0]-this.x,a=this.target[1]-this.y;var e=Math.sqrt(b*b+a*a);if(e<this.v*c){this.x=this.target[0];this.y=this.target[1];this.target=null;return}this.x+=(this.v*c)*b/e;this.y+=(this.v*c)*a/e}};var HitZone={init:function(a){this.r=a||0},hits:function(a,c,b){return Math.abs(a-this.x)<b+this.r&&Math.abs(c-this.y)<b+this.r}};var CheckBoss={die:function(){state.checkbosses()}};var WithinSector={settrack:function(a,b){var d=Math.floor(a/settings.sectorsize);var c=Math.floor(b/settings.sectorsize);this.sectorkey=d+","+c}};function You(a,b){this.setpos(a,b);this.parent=null;this.kjump=999;this.drop();this.heal()}You.prototype=UFX.Thing().addcomp(WorldBound).addcomp(Stands).addcomp(MultiLeaper).addcomp(MovesHorizontal).addcomp(HasHealth,3).addcomp(MercyInvulnerable).addcomp({draw:function(){if(state.jhang){var b=this.upward||this.hover?-0.9:this.parent||this.hanging?0.15:0.8;UFX.draw("fs white [ t 0 50 r",b,"( m 0 0 l 80 0 l 40 20 ) f ]");UFX.draw("fs white [ t 0 50 r",-b,"( m 0 0 l -80 0 l -40 20 ) f ]")}UFX.draw("fs green ( m -25 0 l -15 60 l 15 60 l 25 0 ) f")},land:function(a){state.lastlanding=a;if(a.ischeck){state.savegame()}},takedamage:function(){playsound("hurt")}});function Platform(a,e,b){this.setpos(a,e);this.dx=b;state.claimtiles(this);var d=UFX.random.rand(100,120)+","+UFX.random.rand(100,120)+","+UFX.random.rand(100,120);this.grad=UFX.draw.lingrad(0,0,0,-100,0,"rgb("+d+")",1,"rgba("+d+",0)")}Platform.prototype=UFX.Thing().addcomp(WorldBound).addcomp(IsSurface).addcomp({draw:function(){UFX.draw("fs",this.grad,"fr 0 -100",this.dx*100,100)}}).addcomp(DrawDebugLine,"#266");function VirtualPlatform(a,c,b){this.setpos(a,c);this.dx=b}VirtualPlatform.prototype=UFX.Thing().addcomp(WorldBound).addcomp(DrawLine,"white").addcomp(DrawPlacable);function House(a,c,b){this.setpos(a,c);this.name=b;this.r=3}House.prototype=UFX.Thing().addcomp(WorldBound).addcomp({draw:function(){UFX.draw("fs #424 ss #848 lw 8 ( m -85 0 q -85 100 0 200 q 85 100 85 0 ) f s");UFX.draw("fs #242 ss #484 lw 8 ( m -20 0 c -20 100 -100 100 -60 180 c -50 100 50 100 60 180 c 100 100 20 100 20 0 ) f s");UFX.draw("fs #224 ss #448 lw 8 ( m -100 0 q 0 -20 100 0 q 100 15 90 30 q 0 18 -90 30 q -100 15 -100 0 ) f s")}});function Bat(a,b){this.setpos(a,b);this.settrack(a,b);this.tfly=UFX.random(1000);this.heal();state.monsters.push(this)}Bat.prototype=UFX.Thing().addcomp(WorldBound).addcomp(WithinSector).addcomp(FliesLissajous,3,1,0.7,0.4).addcomp(HitZone,0.2).addcomp(HasHealth,1).addcomp(GivesMoney,1).addcomp(SplatsOnDeath).addcomp({draw:function(){var a=20*[0,1,0,-1][Math.floor(this.tfly*20%4)];UFX.draw("ss #B00 lw 5 b m -50",a,"l 0 0 l 50",a,"s");UFX.draw("fs #700 fr -20 -20 40 40")}});function Zat(a,b){this.setpos(a,b);this.settrack(a,b);this.tfly=UFX.random(1000);this.heal();state.monsters.push(this)}Zat.prototype=UFX.Thing().addcomp(WorldBound).addcomp(WithinSector).addcomp(FliesLissajous,5,3,0.7,1.2).addcomp(HitZone,0.3).addcomp(HasHealth,1).addcomp(GivesMoney,2).addcomp(SplatsOnDeath).addcomp({draw:function(){var a=20*[0,1,0,-1][Math.floor(this.tfly*20%4)];UFX.draw("z 1.5 1.5 ss #BB0 lw 5 b m -50",a,"l 0 0 l 50",a,"s");UFX.draw("fs #770 fr -20 -20 40 40")}});function Wat(a,b){this.setpos(a,b);this.settrack(a,b);this.tfly=UFX.random(1000);this.heal();state.monsters.push(this)}Wat.prototype=UFX.Thing().addcomp(WorldBound).addcomp(WithinSector).addcomp(FliesLissajous,5,3,0.7,1.2).addcomp(HitZone,0.4).addcomp(HasHealth,1).addcomp(GivesMoney,3).addcomp(SplatsOnDeath).addcomp({draw:function(){var a=20*[0,1,0,-1][Math.floor(this.tfly*20%4)];UFX.draw("z 2 2 ss #0BB lw 5 b m -50",a,"l 0 0 l 50",a,"s");UFX.draw("fs #077 fr -20 -20 40 40")}});function Lance(a,c,b){this.setpos(a,c);this.settrack(a,c);this.tfly=tau*b;this.heal();state.monsters.push(this)}Lance.prototype=UFX.Thing().addcomp(WorldBound).addcomp(WithinSector).addcomp(FliesLissajous,2,1,1,2).addcomp(LissajousPulses).addcomp(HitZone,0.4).addcomp(HasHealth,1).addcomp(SplatsOnDeath).addcomp(CheckBoss).addcomp({draw:function(){UFX.draw("r",this.tfly*5%tau);UFX.draw("ss #B00 lw 5 b m -80 0 l 80 0 m 0 -80 l 0 80 s");UFX.draw("fs #700 fr -30 -30 60 60")},die:function(){playsound("explosion")}});function Wilson(a,c,b){this.setpos(a,c);this.settrack(a,c);this.tfly=tau*b;this.heal();state.monsters.push(this)}Wilson.prototype=UFX.Thing().addcomp(WorldBound).addcomp(WithinSector).addcomp(FliesToroidal).addcomp(HitZone,0.4).addcomp(HasHealth,1).addcomp(SplatsOnDeath).addcomp(CheckBoss).addcomp({draw:function(){UFX.draw("r",this.tfly*5%tau);UFX.draw("ss #B00 lw 5 b m -80 0 l 80 0 m 0 -80 l 0 80 s");UFX.draw("fs #700 fr -30 -30 60 60")},die:function(){playsound("explosion")}});function Percy(a,b){this.setpos(a,b);this.settrack(a,b);this.tfly=UFX.random(100);this.heal();state.monsters.push(this)}Percy.prototype=UFX.Thing().addcomp(WorldBound).addcomp(WithinSector).addcomp(FliesErratic,5,2,5).addcomp(HitZone,0.4).addcomp(HasHealth,1).addcomp(SplatsOnDeath).addcomp(CheckBoss).addcomp({draw:function(){UFX.draw("r",this.tfly*5%tau);UFX.draw("ss #B00 lw 5 b m -80 0 l 80 0 m 0 -80 l 0 80 s");UFX.draw("fs #700 fr -30 -30 60 60")},die:function(){playsound("explosion")}});var HasLifetime={init:function(a){this.t0=a||1},live:function(){this.t=this.t0;this.alive=true},think:function(a){this.t=Math.max(this.t-a,0);this.f=1-this.t/this.t0;this.alive=this.t>0}};var Fades={draw:function(){UFX.draw("alpha",1-this.f)}};var HurtsEnemies={init:function(a){this.dhp=a||1},think:function(c){var a=this.x,d=this.y,b=this.r;state.monsters.forEach(function(e){if(e.hits(a,d,b)){if(!e.tmercy){e.takedamage(1)}}})}};function Slash(a,c,b){this.setpos(a,c);this.r=b;this.live();state.effects.push(this)}Slash.prototype=UFX.Thing().addcomp(WorldBound).addcomp(HasLifetime,0.4).addcomp(Fades).addcomp(HurtsEnemies).addcomp({draw:function(){var a=130*this.r*(0.5+0.5*this.f);UFX.draw("ss rgba(255,255,0,0.5) lw 10","b a 0 0",a,"-0.9 0.9 s","b a 0 0",a,"2.24 4.04 s")}});var camera={x0:0,y0:0,z:32,focus:null,zoverride:0,think:function(a){this.z=this.zoverride||Math.min(canvas.width,canvas.height)/(state.sun?26:18);if(this.focus){var b=Math.min(10*a,1);this.x0+=(this.focus.x-this.x0)*b;this.y0+=(this.focus.y-this.y0)*b}this.ymin=this.y0-canvas.height/this.z*0.55;this.ymax=this.y0+canvas.height/this.z*0.55;this.xmin=this.x0-canvas.width/this.z*0.55;this.xmax=this.x0+canvas.width/this.z*0.55},transform:function(){UFX.draw("t",canvas.width/2,canvas.height/2,"z",this.z,-this.z,"t",-this.x0,-this.y0,"z 0.01 0.01")},visible:function(a,c,b){return a>this.xmin-b&&a<this.xmax+b&&c>this.ymin-b&&c<this.ymax+b}};var settings={vyup:20,dup:1.1,hover:0.15,aydown:40,vx:6,hangtimes:[0,0.2,0.3,0.4,0.5,0.6],slashsizes:[0,0.8,1.1,1.4,1.7,2],ahang:1.4,tmercy:1.6,sectorsize:20,psize:3,maxfall:8,rmask:10,pcost:5,housegp:20,musicvolume:0.4};var qobj={};var qstring=window.location.search.slice(1);qstring.split("&").forEach(function(b){var c=b.split("=");if(c.length==1){qobj[c[0]]=true}if(c.length==2){qobj[c[0]]=JSON.parse(decodeURIComponent(c[1]))}});var DEBUG=qobj.DEBUG;var Particles={init:function(b,a){this.nparticles=b||10;this.color=a||"white"},start:function(){this.particles=[];while(this.particles.length<this.nparticles){this.particles.push(UFX.random.rdisk())}},draw:function(){var b=this.r*(0.3+0.7*this.f),a=0.1/b;UFX.draw("z",100*b,100*b,"fs",this.color);this.particles.forEach(function(c){UFX.draw("b o",c[0],c[1],a,"f")})}};var Falls={init:function(a){this.g=a||40},think:function(a){this.y+=this.vy*a-0.5*a*a*this.g;this.vy-=a*this.g}};function Splat(a,c,b){this.setpos(a,c);this.r=b;this.vy=5;this.start();this.live();state.splats.push(this);this.think(0)}Splat.prototype=UFX.Thing().addcomp(WorldBound).addcomp(HasLifetime,0.5).addcomp(Fades).addcomp(Falls).addcomp(Particles,20,"rgba(255,0,0,0.5)");var content={talkelgo:function(){if(this.newcutscene("mission1")){state.done.knowwari=true}else{this.cutscene("healinfo")}},talkwari:function(){if(this.newcutscene("mission2")){state.jhang=1;state.done.knowsemt=true;state.you.maxhp+=1}else{this.cutscene("wingusage")}},talksemt:function(){if(this.newcutscene("mission3")){state.canbuild=true;state.done.knowpald=true;state.you.maxhp+=1}else{this.cutscene("buildusage")}},talkpald:function(){if(this.newcutscene("mission4")){state.canwarp=true;state.done.knowlume=true;state.you.maxhp+=1}else{this.cutscene("warpusage")}},talklume:function(){if(this.newcutscene("mission5")){state.done.knowmian=true;state.done.knowlige=true;state.done.knowsank=true;state.you.maxhp+=1;state.njump+=1}else{if(!state.done.rescuelige){this.cutscene("tosavelige")}else{if(!state.done.rescuesank){this.cutscene("tosavesank")}else{if(!state.done.rescuemian){this.cutscene("tosavemian")}else{if(this.newcutscene("restoresun")){state.njump+=1;state.you.maxhp+=1;state.sun=true;state.gp+=999999999}else{this.cutscene("seeksart")}}}}}},talklige:function(){if(this.newcutscene("getinfolige")){state.you.maxhp+=1;state.jhang+=1}else{this.cutscene("complete")}},talksank:function(){if(this.newcutscene("getinfosank")){state.you.maxhp+=1;state.jhang+=1}else{this.cutscene("complete")}},talkmian:function(){if(this.newcutscene("getinfomian")){state.you.maxhp+=1;state.jhang+=1}else{this.cutscene("complete")}},talksarf:function(){UFX.scene.push("endscene")},cutscene:function(a){UFX.scene.push("cutscene",cutscenes[a])},newcutscene:function(a){if(state.done[a]){return false}state.done[a]=true;UFX.scene.push("cutscene",cutscenes[a]);return true}};var HouseNames={elgo:"Eldar",wari:"Avex",semt:"Kraftin",pald:"Zume",lume:"Brite",lige:"Mentix",sank:"Querda",mian:"Cogno",sarf:"Nirva"};var cutscenes={mission1:["Apprentice, my time is short. My thoughts of late have turned to Heaven.","You've heard the story of Heaven, yes? But do you know what that word means?","What we know as Heaven is in fact the surface of this world, which our ancestors abandoned 100 generations ago.","There is a place beyond the darkness, a place that might still be there, but this fact seems to have been forgotten by our people.","Promise me that you will keep this knowledge alive.","Go to the House of Avex. There you will find a powerful tool."],healinfo:["Remember, return to any House if you need to heal."],mission2:["There was once a lamp brighter than anything you can imagine, called the Artifical Sun.","But sadly it broke many years ago, before you were born.","How I wish you could have seen the daylight....","Since the Sun disappeared, the creatures of the darkness have grown bolder.","Will you sojourn at the House of Kraftin? I have not heard from them in ages and I fear the worst.","Received Wings! You now slash when you jump. Hold Up while jumping to hover."],wingusage:["Have you learned to use your wings?","Press Up near an enemy to slash it. Hold Up and you will hang in the air briefly."],mission3:["Thank you! Never have these creatures attacked Houses before. This is cause for alarm!","Our shelters have served us well for many centuries, but they are finally decaying.","Our ancestors were builders, you know. Very little existed here before they came.","Although most of their technologies have been lost, I can teach you one.","Press and hold Space to create a platform. Use Arrow keys to place it.","Platforms cost "+settings.pcost+"GP each. If you run low, slay some monsters or visit any House.","Please visit the House of Zume. I believe your path lies there."],buildusage:["Have you learned to build pathways?","Press and hold Space while standing on a platform.","Choose the placement with the arrow keys, then release Space to build.","What? You want to build a path to Heaven? No, it would never work.","These pathways cannot be built above 60 fathoms. Such technology is long lost, I'm afraid."],mission4:["Wow, close one. I don't know how much longer we can last.","Look, I know that mentor of yours likes old stories of Heaven and salvation, but we have real problems to deal with.","Right now we need to turn the Sun back on, before these attacks destroy us.","Find the House of Brite and see what can be done, if it's not too late.","Got warp! Press Tab to warp between Houses you've visited."],warpusage:["Press Tab at any time to warp to a random House that you've already visited.","Houses will refill your health and money (up to 20GP) and save your progress."],mission5:["This is where we once controlled the Artificial Sun, but we have not seen daylight in many years.","I could repair it, I know, if only I had replacement parts....","The technology of our ancestors is thought to be lost, but it is simply scattered.","Perhaps if you visit the Houses of Mentix, Querda, and Cogno, you may find what I need.","Learned Double Jump! Tap Up twice."],tosavelige:["Visit the Houses of Mentix, Querda, and Cogno to restore the Sun.","You still have not come back from Mentix."],tosavesank:["Visit the Houses of Mentix, Querda, and Cogno to restore the Sun.","You still have not come back from Querda."],tosavemian:["Visit the Houses of Mentix, Querda, and Cogno to restore the Sun.","You still have not come back from Cogno."],getinfolige:["The House of Brite seeks to restore the Sun?","Their retroencabulator must be broken, please take this replacement!","Wings upgraded!"],getinfosank:["The House of Brite seeks to restore the Sun?","Their improbability drive must be broken, please take this replacement!","Wings upgraded!","Er.... I don't really know how to get out of here. Better press Tab."],getinfomian:["The House of Brite seeks to restore the Sun?","Their flux capacitor must be broken, please take this replacement!","Wings upgraded!"],restoresun:["Amazing! With the parts you've collected, I think we may be able to restore the Sun....","....","Let there be light!","Got triple jump!","Got unlimited GP!"],seeksart:["Thanks to you, the light is restored.... for now.","You want to know if there is a path to Heaven? As in the actual Heaven?","Legend tells of one to the east, of course, but I'm sure it's long gone, if it ever existed.","Still...."],complete:["Good luck, young one."]};UFX.scenes.cutscene={start:function(a){this.texts=a.slice(0)},thinkargs:function(a){return[a,UFX.key.state()]},think:function(b,a){if(a.down.space){this.texts.shift();if(!this.texts.length){UFX.scene.pop();playsound("powerup");playmusic("song"+state.njump)}}},draw:function(){UFX.scenes.play.draw();UFX.draw("fs rgba(0,0,0,0.9) f0");if(!this.texts[0]){return}UFX.draw("[ fs white sh #00A 1 1 0 font 40px~'Pirata~One' textalign center");wordwrap(this.texts[0],500,context).forEach(function(b,a,c){context.fillText(b,canvas.width/2,canvas.height/2+50*(a-c.length/2))});UFX.draw("]")}};UFX.scenes.endscene={start:function(a){this.texts=["Whoa, you okay? Did you just come out of that hole in the ground?","You having trouble seeing? It's just sunlight. Let's get you inside.","Now, how long have you been down there? Your whole life?!","What? Is this 'Heaven'? Yeah sure, whatever you want. Just sit tight for a minute.","How many of you people are underground? A whole race?! Holy smokes, what a find!","Hey, do you have an agent? Of course not, I'll be your agent. I'm your best friend, after all!","A race of subterranian people... hey, are you a cannibal? No? Okay, well, maybe we can say you are anyway.","I can see it now... front pages... talk shows... here we come!","Welcome to Heaven, kid, you're gonna love it!"]},thinkargs:function(a){return[a,UFX.key.state()]},think:function(b,a){if(a.down.space){this.texts.shift();if(!this.texts.length){UFX.scene.pop();UFX.scene.swap("reset")}}},draw:function(){UFX.scenes.play.draw();UFX.draw("fs rgba(0,0,0,0.9) f0");if(!this.texts[0]){return}UFX.draw("[ fs white sh #00A 1 1 0 font 40px~'Pirata~One' textalign center");wordwrap(this.texts[0],500,context).forEach(function(b,a,c){context.fillText(b,canvas.width/2,canvas.height/2+50*(a-c.length/2))});UFX.draw("]")}};function wordwrap(h,d,c){c=c||context;d=d||c.canvas.width;var g=[h],i=0,f;while(c.measureText(g[i]).width>d&&(f=g[i].indexOf(" "))>-1){var e=g[i],b=e.lastIndexOf(" ");while(c.measureText(e.substr(0,b)).width>d&&b>f){b=e.lastIndexOf(" ",b-1)}g[i++]=e.substr(0,b);g.push(e.substr(b+1))}return g}var tau=6.283185307179586;var canvas=document.getElementById("canvas");var context=canvas.getContext("2d");UFX.draw.setcontext(context);if(!DEBUG){UFX.key.watchlist="up down left right space tab".split(" ")}UFX.key.init();UFX.key.remaparrows(true);UFX.key.qdown=true;UFX.maximize.fill(canvas,"total");UFX.scenes.title={think:function(){if(loadf>=1&&UFX.key.ispressed.space){UFX.scene.swap("play")}},draw:function(){UFX.draw("fs #444 f0");UFX.draw("fs white ss black");var a=Math.floor(Math.min(canvas.width/20,canvas.height/10));UFX.draw("[ lw 2 textalign center t",canvas.width/2,canvas.height/2);UFX.draw("font",2*a+"px~'Piedra' fst Ad~Astra 0",-2.4*a);UFX.draw("font",a+"px~'Piedra' fst by~Christopher~Night 0 0");UFX.draw("font",a+"px~'Piedra' fst Universe~Factory~Games 0",1.2*a);if(loadf>=1){UFX.draw("font",1.4*a+"px~'Piedra' fst press~Space~to~"+(localStorage.LD29save?"continue":"begin"),0,4*a)}else{UFX.draw("font",1.4*a+"px~'Piedra' fst Loading:~"+Math.round(100*loadf)+"%",0,4*a)}UFX.draw("]")}};UFX.scenes.death={start:function(){this.t=0},think:function(a){this.t+=a;if(this.t>2){UFX.scene.swap("title")}},draw:function(){if(this.t<1){UFX.scenes.play.draw()}else{UFX.scenes.title.draw()}var a=Math.min(Math.max(1-Math.abs(this.t-1),0),1);UFX.draw("[ fs red alpha",a,"f0 ]")}};UFX.scenes.reset={start:function(){this.t=0},think:function(a){this.t+=a;if(this.t>2){UFX.scene.swap("title")}},draw:function(){if(this.t<1){UFX.scenes.play.draw()}else{UFX.scenes.title.draw()}var a=Math.min(Math.max(1-Math.abs(this.t-1),0),1);UFX.draw("[ fs white alpha",a,"f0 ]")}};var loadf=0;UFX.scene.init({ups:60,maxupf:6});UFX.scene.push("title");UFX.resource.onloading=function(a){loadf=a};UFX.resource.onload=function(){loadf=1;UFX.resource.mergesounds("jump")};function playsound(a){try{UFX.resource.sounds[a].play()}catch(b){}}var musicplaying=null,musicvolume=settings.musicvolume;function playmusic(c){try{var a=UFX.resource.sounds[c];if(a===musicplaying){return}if(musicplaying){musicplaying.pause()}a.volume=musicvolume;a.currentTime=0;a.play();a.loop=true;musicplaying=a}catch(b){}}UFX.resource.loadwebfonts("Viga","Pirata One","Sansita One","Piedra");UFX.resource.load({gamedata:"gamedata.json",jump0:"sfx/jump0.ogg",jump1:"sfx/jump1.ogg",jump2:"sfx/jump2.ogg",jump3:"sfx/jump3.ogg",hurt:"sfx/hurt.ogg",powerup:"sfx/powerup.ogg",pickup:"sfx/pickup.ogg",explosion:"sfx/explosion.ogg",warp:"sfx/warp.ogg",defeat:"sfx/defeat.ogg",song1:"sfx/cheese.ogg",song2:"sfx/hands.ogg",song3:"sfx/tired.ogg"});</script>