// Unminified at: https://code.google.com/p/unifac/source/browse/#hg%2F0
function getlevels(){var e=["north","south"];if(beaten.north){e.push("northwest");e.push("northeast")}if(beaten.south){e.push("southwest");e.push("southeast")}if(beaten.southwest&&beaten.northwest){e.push("west")}if(beaten.southeast&&beaten.northeast){e.push("east")}if(beaten.east&&beaten.west){e.push("0")}var t=function(e){return!beaten[e]};return e.filter(t)}function Piece(e,t,n,r,i){this.name=e;this.x=n||0;this.y=r||0;this.path=t||this.path;this.r=i||2}function Target(e,t){this.x=e;this.y=t}function Dagger(e,t){this.x=e;this.y=t}function Sister(e,t,n){this.x=e;this.y=t;this.sister=n}function Bit(e,t){this.x=e;this.y=t;this.t=Math.random()*1e3;this.think(0)}function Spin(){}function Deploy(e){var t=Math.atan2(e.x,e.y);this.hT0=.1*t}function Undeploy(e){var t=Math.atan2(e.x,e.y);this.hT0=.1*t}function GrowFade(){}function GrowFadeHalt(){}function Ghost(e,t){this.thing0=e;this.thing1=t;var n=t.x-e.x,r=t.y-e.y;this.T=Math.sqrt(Math.max(n*n+r*r,1))/settings.ghostv;this.think(0);this.trans={kills:true}}function drawdebuginfo(){if(!settings.DEBUG)return;var e=canvas.width+"x"+canvas.height+"  "+UFX.ticker.getrates();UFX.draw("textbaseline top font 36px~monospace fs white ss black lw 1","fst",e.replace(/ /g,"~"),"12 12")}function clip(e,t,n){return n===undefined?e>t?t:e<-t?-t:e:e>n?n:e<t?t:e}function rmod(e,t){return(e%t+t)%t}function zmod(e,t){return((e+t/2)%t+t)%t-t/2}function play(e){if(settings.silent)return;if(UFX.resource.sounds[e]&&UFX.resource.sounds[e].play){UFX.resource.sounds[e].play()}}if(typeof UFX=="undefined")UFX={};UFX.maximize={resizemode:"fixed",preventscroll:true,fillcolor:"black",onadjust:null,init:function(e){function t(e,t){return function(){e[t]()}}this.element=e;this.mode=null;this.calladjust=t(this,"adjust");this.getsettings()},setmode:function(e){if(this.mode==e)return;if(this.mode=="fill")window.removeEventListener("resize",this.calladjust);if(this.mode=="full"){document.cancelFullscreen();window.removeEventListener("resize",this.calladjust)}this.mode=e;if(this.mode=="fill")window.addEventListener("resize",this.calladjust);if(this.mode=="full"){this.element.requestFullscreen();window.addEventListener("resize",this.calladjust)}},adjust:function(){var e=window.innerWidth,t=window.innerHeight;var n=this.element.width,r=this.element.height;var i,s,o,u;if(this.resizemode=="none"){}else if(this.resizemode=="fixed"){if(n*t>r*e){i=e;s=Math.round(e*r/n)}else{i=Math.round(t*n/r);s=t}}else if(this.resizemode=="aspect"){if(n*t>r*e){o=i=e;u=s=Math.round(e*r/n)}else{o=i=Math.round(t*n/r);u=s=t}}else if(this.resizemode=="total"){o=i=e;u=s=t}var a=this.element.style;if(i){a.width=i+"px";a.height=s+"px"}if(o){this.element.width=o;this.element.height=u}if(this.mode=="fill"){var f=e-(i||o||this.element.width);var l=t-(s||u||this.element.height);a.borderLeft=a.borderRight=f>0?.5*f+1+"px "+this.fillcolor+" solid":"none";a.borderTop=a.borderBottom=l>0?.5*l+1+"px "+this.fillcolor+" solid":"none";setTimeout(function(){window.scrollTo(0,1)},1)}else if(this.mode=="full"){a.borderLeft=a.borderRight="none";a.borderTop=a.borderBottom="none"}if(this.onadjust){this.onadjust(this.element,this.element.width,this.element.height)}},fill:function(e){if(e)this.init(e);this.setmode("fill");if(this.preventscroll){document.body.addEventListener("touchstart",this.preventdefault);this.scrollprevented=true}this.adjust();var t=this.element.style;t.position="absolute";t.left="0px";t.top="1px";document.body.style.overflow="hidden"},full:function(e){if(e)this.init(e);this.setmode("full");var t=this;setTimeout(function(){if(t.getfullscreenelement()===t.element){t.adjust()}else{t.restore()}},100)},maximize:function(e){if(e)this.init(e);if(!this.element.requestFullscreen){this.fill();return}this.setmode("full");var t=this;setTimeout(function(){if(t.getfullscreenelement()===t.element){}else{t.fill()}},100)},getfullscreenelement:function(){return document.getFullscreenElement},restore:function(){this.setmode();if(this.scrollprevented){document.body.removeEventListener("touchstart",this.preventdefault);this.scrollprevented=false}this.restoresettings();if(this.onadjust){this.onadjust(this.element,this.element.width,this.element.height)}},getsettings:function(){var e=this.element.style,t=this.settings={width:this.element.width,height:this.element.height,overflow:document.body.style.overflow,style:{}};var n="width height position left top borderLeft borderRight borderTop borderBottom border".split(" ");n.forEach(function(n){t.style[n]=e[n]})},restoresettings:function(){var e=this.element.style,t=this.settings;this.element.width=this.settings.width;this.element.height=this.settings.height;document.body.style.overflow=this.settings.overflow;var n="width height position left top borderLeft borderRight borderTop borderBottom border".split(" ");n.forEach(function(n){e[n]=t.style[n]})},fillnoresize:function(){es.position="absolute";es.left="0px";es.top="1px";this.setbordersizes(wx-px,wy-py);document.body.style.overflow="hidden"},preventdefault:function(e){e.preventDefault()}};if(typeof UFX=="undefined")UFX={};UFX.resource={};UFX.resource.images={};UFX.resource.sounds={};UFX.resource.imagetypes="png gif jpg jpeg bmp tiff".split(" ");UFX.resource.soundtypes="wav mp3 ogg au".split(" ");UFX.resource.base=null;UFX.resource.onload=function(){};UFX.resource.onloading=function(e){};UFX.resource.load=function(){var e=UFX.resource._extractlist(arguments);for(var t=0;t<e.length;++t){var n=e[t];UFX.resource._load(n[0],n[1])}if(UFX.resource._toload===0){setTimeout(UFX.resource.onload,0)}};UFX.resource.loadimage=function(){var e=UFX.resource._extractlist(arguments);for(var t=0;t<e.length;++t){var n=e[t];UFX.resource._loadimage(n[0],n[1])}};UFX.resource.loadsound=function(){var e=UFX.resource._extractlist(arguments);for(var t=0;t<e.length;++t){var n=e[t];UFX.resource._loadsound(n[0],n[1])}};UFX.resource.loadwebfonts=function(){WebFontConfig={google:{families:Array.prototype.slice.call(arguments)},fontactive:UFX.resource._onload};var e=document.createElement("script");e.src="https://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js";e.type="text/javascript";e.async="true";document.getElementsByTagName("head")[0].appendChild(e);UFX.resource._toload+=arguments.length};UFX.resource.Multisound=function(e,t){var n=Object.create(UFX.resource.Multisound.prototype);n._init(e,t);return n};UFX.resource.Multisound.prototype={_init:function(e,t){this.src=typeof e=="string"?e:e.src;this._sounds=[];this._n=t||10;this._k=0;this.volume=1;for(var n=0;n<this._n;++n){var r=new Audio;r.src=this.src;this._sounds.push(r)}},play:function(){var e=this._sounds[this._k++];this._k%=this._n;e.volume=this.volume;e.play()},pause:function(){for(var e=0;e<this._n;++e){this._sounds[e].pause()}}};UFX.resource.SoundRandomizer=function(e,t){if(!(this instanceof UFX.resource.SoundRandomizer))return new UFX.resource.SoundRandomizer(e,t);this._sounds=[];for(var n=0;n<e.length;++n){this._sounds.push(typeof e[n]=="string"?UFX.resource.sounds[e[n]]:e[n])}this._nskip=Math.min(this._sounds.length-1,t||3);this._played=[];this.volume=1};UFX.resource.SoundRandomizer.prototype={play:function(){do{var e=UFX.random.rand(this._sounds.length)}while(this._played.indexOf(e)>-1);var t=this._sounds[e];t.volume=this.volume;t.play();if(this._nskip){this._played.push(e);while(this._played.length>=this._nskip)this._played=this._played.slice(1)}},pause:function(){for(var e=0;e<this._sounds.length;++e){this._sounds[e].pause()}}};UFX.resource.mergesounds=function(){for(var e=0;e<arguments.length;++e){var t=[],n=arguments[e];for(var r in UFX.resource.sounds){if(r.indexOf(n)==0){t.push(r)}}UFX.resource.sounds[n]=UFX.resource.SoundRandomizer(t)}};UFX.resource._seturl=function(e){if(!UFX.resource.base)return e;var t=UFX.resource.base.length;if(!t)return e;return UFX.resource.base+(UFX.resource.base.charAt(t-1)=="/"?"":"/")+e};UFX.resource._load=function(e,t){var n=t.split(".").pop();if(UFX.resource.imagetypes.indexOf(n)>-1){return UFX.resource._loadimage(e,t)}else if(UFX.resource.soundtypes.indexOf(n)>-1){return UFX.resource._loadsound(e,t)}console.log("Treating unknown extension "+n+" as image");return UFX.resource._loadimage(e,t)};UFX.resource._loadimage=function(e,t){var n=new Image;n.onload=UFX.resource._onload;n.src=UFX.resource._seturl(t);n.iname=e;UFX.resource.images[e]=n;++UFX.resource._toload};UFX.resource._loadsound=function(e,t){var n=new Audio;n.addEventListener("canplaythrough",UFX.resource._onload,false);n.src=UFX.resource._seturl(t);n.aname=e;UFX.resource.sounds[e]=n;++UFX.resource._toload};UFX.resource._extractlist=function(e){var t=[];for(var n=0;n<e.length;++n){var r=e[n];if(typeof r=="string"){t.push([r,r])}else if(r instanceof Array){for(var i=0;i<r.length;++i){t.push([r[i],r[i]])}}else{for(var i in r){t.push([i,r[i]])}}}return t};UFX.resource._toload=0;UFX.resource._loaded=0;UFX.resource._onload=function(){++UFX.resource._loaded;var e=1*UFX.resource._loaded/UFX.resource._toload;UFX.resource.onloading(e);if(UFX.resource._loaded===UFX.resource._toload){UFX.resource.onload()}};if(typeof UFX=="undefined")UFX={};UFX.ticker={defaultopts:{sync:"auto",cthis:null,delay:0,minupf:1,maxupf:1,ups:null,minups:null,maxups:null,fps:30},init:function(e,t,n){this.setcallbacks(e,t);this.setoptions(n);this.resume()},setcallbacks:function(e,t){this._tcallback=e;this._dcallback=t},setoptions:function(e,t){if(!t){for(var n in this.defaultopts){this[n]=this.defaultopts[n]}}if(!e)return;for(var n in this.defaultopts){if(n in e){this[n]=e[n]}}},resume:function(){this.stop();this._running=true;this._tick()},stop:function(){if(this._shandle)window.cancelAnimationFrame(this._shandle);if(this._thandle)clearTimeout(this._thandle);this._shandle=this._thandle=null;this._running=false;this.resetcounters()},resetcounters:function(){this._accumulator=0;this._dtu=0;this._dtg=0;this._dtf=0;this._lastthink=Date.now();this._lastdraw=Date.now();this.wfactor=1},getrates:function(){return[this.wfps.toPrecision(3)+"fps",this.wups.toPrecision(3)+"ups",this.wfactor.toPrecision(3)+"x"].join(" ")},_tick:function(){if(!this._running)return;var e=Date.now();var t=this._lasttick?(e-this._lasttick)*.001:0;this._lasttick=e;this._accumulator+=t;var n=this.fps;var r=this.minupf;var i=this.maxupf;var s=this.minups||this.ups||n;var o=this.maxups||this.ups||s;var u,a,f,l;if(r==0){u=true}else{u=this._accumulator>=r/o}if(!u){a=0;l=r/o}else if(r>=i){a=r;l=f=Math.min(this._accumulator,r/s)}else{var c=Math.floor(this._accumulator*s);if((c+1)/o<=this._accumulator)c+=1;a=Math.max(Math.min(c,i),r);f=Math.min(a/s,this._accumulator);l=Math.max(r,1)/o}if(a){this._accumulator-=f;f/=a;for(var h=0;h<a;++h){this._tcallback.call(this.cthis,f,h,a);e=Date.now();this._dtu=.95*this._dtu+.05*(e-this._lastthink);this._dtg=.95*this._dtg+.05*f*1e3;this._lastthink=e}}if(u&&this._dcallback){var p=this._accumulator*s;this._dcallback.call(this.cthis,p);e=Date.now();this._dtf=.95*this._dtf+.05*(e-this._lastdraw);this._lastdraw=e}this._accumulator=Math.max(Math.min(this._accumulator,l),0);this.wups=1e3/this._dtu;this.wfps=this._dcallback?1e3/this._dtf:this.wups;this.wfactor=this._dtg/this._dtu;if(!this._running)return;var d=this.sync=="auto"?window.requestAnimationFrame:this.sync;this._shandle=this._thandle=null;var v=function(e){return function(){e._tick()}}(this);if(d){this._shandle=window.requestAnimationFrame(v)}else{var m=this._lasttick+(l-this._accumulator);var g=Math.max(Date.now()-m,this.delay);g=0;this._thandle=window.setTimeout(v,g)}}};if(typeof UFX=="undefined")UFX={};UFX.SceneStack=function(){if(!(this instanceof UFX.SceneStack))return new UFX.SceneStack;this._actionq=[];this._stack=[];this.resolveargs=true;this.recorder=null;this.frozen=false};UFX.SceneStack.prototype={init:function(e,t){e=Object.create(e||null);e.cthis=this;UFX.ticker.init(this.think,this.draw,e,t)},top:function(){var e=this._stack.length;return e?this._stack[e-1]:null},getscene:function(e){if(typeof e==="string"){if(e.substr(0,4)=="new_"){e=e.substr(4);if(!(e in UFX.scenes))throw"Unrecognized scene: "+e;return new UFX.scenes[e]}else if(e.substr(0,7)=="create_"){e=e.substr(7);if(!(e in UFX.scenes))throw"Unrecognized scene: "+e;return Object.create(UFX.scenes[e])}if(!(e in UFX.scenes))throw"Unrecognized scene: "+e;return UFX.scenes[e]}return e},ipush:function(e){if(this.frozen)return;var t=this.top();if(t&&t.suspend)t.suspend();var n=this.getscene(e);this._stack.push(n);var r=Array.prototype.slice.call(arguments,1);if(this.resolveargs&&n.startargs)r=n.startargs.apply(n,r);if(this.recorder)this.recorder.addpush(e,r);if(n.checkpoint&&this.recorder){this.recorder.checkpoint(n.getchaptername?n.getchaptername.apply(n,r):e)}if(n.start)n.start.apply(n,r)},ipop:function(){if(this.frozen)return;var e=this._stack.pop();if(e.stop)e.stop();var t=this.top();if(t&&t.resume)t.resume();if(this.recorder)this.recorder.addpop();return e},iswap:function(e){if(this.frozen)return;var t=this._stack.pop();if(t&&t.stop)t.stop();var n=this.getscene(e);this._stack.push(n);var r=Array.prototype.slice.call(arguments,1);if(this.resolveargs&&n.startargs)r=n.startargs.apply(n,r);if(this.recorder)this.recorder.addswap(e,r);if(n.checkpoint&&this.recorder){this.recorder.checkpoint(n.getchaptername?n.getchaptername.apply(n,r):e)}if(n.start)n.start.apply(n,r);return t},push:function(){this._actionq.push(["push",Array.prototype.slice.call(arguments,0)])},pop:function(){this._actionq.push(["pop"])},swap:function(){this._actionq.push(["swap",Array.prototype.slice.call(arguments,0)])},_resolveq:function(){for(var e=0;e<this._actionq.length;++e){switch(this._actionq[e][0]){case"push":this.ipush.apply(this,this._actionq[e][1]);break;case"pop":this.ipop();break;case"swap":this.iswap.apply(this,this._actionq[e][1]);break}}this._actionq=[]},think:function(){this._resolveq();var e=this.top();this._lastthinker=e;if(e){var t=arguments;if(this.resolveargs&&e.thinkargs)t=e.thinkargs.apply(e,t);if(this.recorder)this.recorder.addthink(t);if(e.think)e.think.apply(e,t)}},draw:function(){var e=this._lastthinker;if(e&&e.draw){e.draw.apply(e,arguments)}}};UFX.scene=new UFX.SceneStack;UFX.scenes={};if(typeof UFX=="undefined")UFX={};UFX._draw=function(){function t(){for(var n=0;n<arguments.length;++n){var r=arguments[n];if(r.split)e.push.apply(e,r.split(" "));else if(r instanceof Array)t.apply(this,r);else e.push(r)}}function r(e){if(typeof e!=="string")return e;switch(e.substr(0,3)){case"lg~":return UFX._draw.lingrad.apply(n,e.substr(3).split("~"));case"rg~":return UFX._draw.radgrad.apply(n,e.substr(3).split("~"));default:return e}}var e=[];t.apply(this,arguments);var n=this;for(var i=0;i<e.length;++i){switch(e[i].toLowerCase()){case"b":case"(":case"beginpath":this.beginPath();break;case")":case"closepath":this.closePath();break;case"m":case"moveto":this.moveTo(+e[++i],+e[++i]);break;case"l":case"lineto":this.lineTo(+e[++i],+e[++i]);break;case"q":case"quadraticcurveto":this.quadraticCurveTo(+e[++i],+e[++i],+e[++i],+e[++i]);break;case"c":case"beziercurveto":this.bezierCurveTo(+e[++i],+e[++i],+e[++i],+e[++i],+e[++i],+e[++i]);break;case"a":case"arc":this.arc(+e[++i],+e[++i],+e[++i],+e[++i],+e[++i]);break;case"aa":case"antiarc":this.arc(+e[++i],+e[++i],+e[++i],+e[++i],+e[++i],true);break;case"arcto":this.arcTo(+e[++i],+e[++i],+e[++i],+e[++i],+e[++i]);break;case"o":case"circle":this.arc(+e[++i],+e[++i],+e[++i],0,2*Math.PI);break;case"rr":case"roundedrect":var s=+e[++i],o=+e[++i],u=+e[++i],a=+e[++i],f=+e[++i];this.beginPath();this.moveTo(s+f,o);this.arcTo(s+u,o,s+u,o+a,f);this.arcTo(s+u,o+a,s,o+a,f);this.arcTo(s,o+a,s,o,f);this.arcTo(s,o,s+u,o,f);this.closePath();break;case"t":case"translate":this.translate(+e[++i],+e[++i]);break;case"r":case"rotate":this.rotate(+e[++i]);break;case"z":case"scale":this.scale(+e[++i],+e[++i]);break;case"zx":case"xscale":this.scale(+e[++i],1);break;case"zy":case"yscale":this.scale(1,+e[++i]);break;case"hflip":this.scale(-1,1);break;case"vflip":this.scale(1,-1);break;case"x":case"transform":this.transform(+e[++i],+e[++i],+e[++i],+e[++i],+e[++i],+e[++i]);break;case"xshear":this.transform(1,0,+e[++i],1,0,0);break;case"yshear":this.transform(1,+e[++i],0,1,0,0);break;case"f":case"fill":this.fill();break;case"s":case"stroke":this.stroke();break;case"fr":case"fillrect":this.fillRect(+e[++i],+e[++i],+e[++i],+e[++i]);break;case"sr":case"strokerect":this.strokeRect(+e[++i],+e[++i],+e[++i],+e[++i]);break;case"fsr":case"fillstrokerect":var s=+e[++i],o=+e[++i],u=+e[++i],a=+e[++i];this.fillRect(s,o,u,a);this.strokeRect(s,o,u,a);break;case"cr":case"clearrect":this.clearRect(+e[++i],+e[++i],+e[++i],+e[++i]);break;case"f0":case"fillall":this.fillRect(0,0,this.canvas.width,this.canvas.height);break;case"c0":case"clearall":this.clearRect(0,0,this.canvas.width,this.canvas.height);break;case"fs":case"fillstyle":this.fillStyle=r(e[++i]);break;case"ss":case"strokestyle":this.strokeStyle=r(e[++i]);break;case"shadowblur":case"shb":this.shadowBlur=+e[++i];break;case"shadowcolor":case"shc":this.shadowColor=r(e[++i]);break;case"shadowoffsetx":case"shadowx":case"shx":this.shadowOffsetX=+e[++i];break;case"shadowoffsety":case"shadowy":case"shy":this.shadowOffsetY=+e[++i];break;case"shadowoffsetxy":case"shadowxy":case"shxy":this.shadowOffsetX=+e[++i];this.shadowOffsetY=+e[++i];break;case"shadow":case"sh":this.shadowColor=r(e[++i]);this.shadowOffsetX=+e[++i];this.shadowOffsetY=+e[++i];this.shadowBlur=+e[++i];break;case"drawimage":this.drawImage(e[++i],+e[++i],+e[++i]);break;case"drawimage0":this.drawImage(e[++i],0,0);break;case"clip":this.clip();break;case"al":case"alpha":case"globalalpha":this.globalAlpha=+e[++i];break;case"lw":case"linewidth":this.lineWidth=+e[++i];break;case"lc":case"linecap":this.lineCap=e[++i];break;case"textalign":this.textAlign=e[++i];break;case"textbaseline":this.textBaseline=e[++i];break;case"[":case"save":this.save();break;case"]":case"restore":this.restore();break;case"font":this.font=e[++i].replace(/~/g," ");break;case"filltext":case"ft":this.fillText(e[++i].replace(/~/g," "),+e[++i],+e[++i]);break;case"filltext0":case"ft0":this.fillText(e[++i].replace(/~/g," "),0,0);break;case"stroketext":case"st":this.strokeText(e[++i].replace(/~/g," "),+e[++i],+e[++i]);break;case"stroketext0":case"st0":this.strokeText(e[++i].replace(/~/g," "),0,0);break;case"fillstroketext":case"fst":var l=e[++i].replace(/~/g," "),s=+e[++i],o=+e[++i];this.fillText(l,s,o);this.strokeText(l,s,o);break;case"fillstroketext0":case"fst0":var l=e[++i].replace(/~/g," ");this.fillText(l,0,0);this.strokeText(l,0,0);break;default:throw"Unrecognized draw token "+e[i]}}};UFX._draw.circle=function(e,t,n,r,i,s){this.save();this.beginPath();this.arc(e,t,n,0,2*Math.PI);if(r){this.fillStyle=r;this.fill()}if(i||s){if(i)this.strokeStyle=i;if(s)this.lineWidth=s;this.stroke()}this.restore()};UFX._draw.lingrad=function(e,t,n,r){var i=this.createLinearGradient(+e,+t,+n,+r);for(var s=4;s<arguments.length;s+=2){i.addColorStop(+arguments[s],arguments[s+1])}return i};UFX._draw.radgrad=function(e,t,n,r,i,s){var o=this.createRadialGradient(+e,+t,+n,+r,+i,+s);for(var u=6;u<arguments.length;u+=2){o.addColorStop(+arguments[u],arguments[u+1])}return o};UFX.draw=function(e){if(e.beginPath){return UFX._draw.apply(e,Array.prototype.slice.call(arguments,1))}else if(UFX.draw._context){return UFX._draw.apply(UFX.draw._context,arguments)}else{throw"UFX.draw must be called with context as first argument"}};for(var mname in UFX._draw){UFX.draw[mname]=function(e,t){return function(t){if(t.beginPath){return e.apply(t,Array.prototype.slice.call(arguments,1))}else{if(!UFX.draw._context)UFX.draw._context=document.createElement("canvas").getContext("2d");return e.apply(UFX.draw._context,arguments)}}}(UFX._draw[mname],mname)}UFX.draw.setcontext=function(e){UFX.draw._context=e};UFX.draw.extend=function(e){e.draw=function(){UFX._draw.apply(e,arguments)};for(var t in UFX._draw){e.draw[t]=function(t){return function(){return t.apply(e,arguments)}}(UFX._draw[t])}};if(typeof UFX=="undefined")UFX={};UFX.mouse={};UFX.mouse.active=true;UFX.mouse.qdown=true;UFX.mouse.qup=true;UFX.mouse.qclick=false;UFX.mouse.qblur=false;UFX.mouse.qwheel=false;UFX.mouse.capture={left:true,middle:false,right:false,wheel:false};UFX.mouse.watchdrag=true;UFX.mouse.drag=null;UFX.mouse.events=function(){var e=UFX.mouse._events;UFX.mouse.clearevents();return e};UFX.mouse.state=function(){var e={};if(UFX.mouse.capture.left)e.left={};if(UFX.mouse.capture.middle)e.middle={};if(UFX.mouse.capture.right)e.right={};UFX.mouse._events.forEach(function(t){e[UFX.mouse._buttonmap[t.button]][t.type]=t.pos});UFX.mouse.clearevents();if(UFX.mouse.capture.wheel)e.wheeldy=UFX.mouse.getwheeldy();if(UFX.mouse.watchdrag&&UFX.mouse.drag){var t=UFX.mouse.drag;e[UFX.mouse._buttonmap[t.button]].drag={dx:t.pos[0]-t.opos[0],dy:t.pos[1]-t.opos[1]};t.opos=t.pos}e.pos=UFX.mouse.pos;return e};UFX.mouse.clearevents=function(){UFX.mouse._events=[]};UFX.mouse.getwheeldy=function(){var e=UFX.mouse.wheeldy;UFX.mouse.wheeldy=0;return e};UFX.mouse.pos=null;UFX.mouse.wheeldy=0;UFX.mouse.init=function(e,t){UFX.mouse._captureevents(e,t)};UFX.mouse._events=[];UFX.mouse._captureevents=function(e,t){e=e||document;t=t||document;if(typeof e=="string")e=document.getElementById(e);if(typeof t=="string")t=document.getElementById(t);t.addEventListener("blur",UFX.mouse._onblur,true);e.onmouseout=UFX.mouse._onmouseout;e.onmousedown=UFX.mouse._onmousedown;t.onmouseup=UFX.mouse._onmouseup;e.onclick=UFX.mouse._onclick;e.oncontextmenu=UFX.mouse._oncontextmenu;e.onmousewheel=UFX.mouse._onmousewheel;e.addEventListener("DOMMouseScroll",UFX.mouse._onmousewheel);t.onmousemove=UFX.mouse._onmousemove;UFX.mouse._element=e;UFX.mouse._backdrop=t};UFX.mouse._elemoffset=function(e){var t=e.getBoundingClientRect();var n=t.left+e.clientLeft-e.scrollLeft;var r=t.top+e.clientTop-e.scrollTop;return[n,r]};UFX.mouse._geteventpos=function(e,t){var n=UFX.mouse._elemoffset(t||e.target);return[e.clientX-n[0],e.clientY-n[1]]};UFX.mouse._onblur=function(e){if(!UFX.mouse.active)return true;return true};UFX.mouse._onmouseout=function(e){};UFX.mouse._oncontextmenu=function(e){if(!UFX.mouse.active||!UFX.mouse.capture.right)return true;e.preventDefault();return false};UFX.mouse._buttonmap=["left","middle","right"];UFX.mouse._onclick=function(e){if(!UFX.mouse.active||!UFX.mouse.capture[UFX.mouse._buttonmap[e.button]])return true;if(UFX.mouse.qclick){var t={type:"click",pos:UFX.mouse._geteventpos(e,UFX.mouse._element),button:e.button,time:Date.now(),baseevent:e};UFX.mouse._events.push(t)}e.preventDefault();return false};UFX.mouse._onmousedown=function(e){if(!UFX.mouse.active||!UFX.mouse.capture[UFX.mouse._buttonmap[e.button]])return true;var t=UFX.mouse._geteventpos(e);if(UFX.mouse.watchdrag){UFX.mouse.drag={downevent:e,button:e.button,pos0:t,opos:t,pos:t,dx:0,dy:0,t0:Date.now(),dt:0}}if(UFX.mouse.qdown){var n={type:"down",pos:UFX.mouse._geteventpos(e,UFX.mouse._element),button:e.button,time:Date.now(),baseevent:e};UFX.mouse._events.push(n)}e.preventDefault();return false};UFX.mouse._onmouseup=function(e){if(!UFX.mouse.active||!UFX.mouse.capture[UFX.mouse._buttonmap[e.button]])return true;if(!UFX.mouse.drag)return true;if(UFX.mouse.qup){var t={type:"up",pos:UFX.mouse._geteventpos(e,UFX.mouse._element),button:e.button,time:Date.now(),baseevent:e};if(UFX.mouse.drag){t.t0=UFX.mouse.drag.t0;t.dt=Date.now()-t.t0;t.pos0=UFX.mouse.drag.pos0;t.dx=t.pos[0]-t.pos0[0];t.dy=t.pos[1]-t.pos0[1]}UFX.mouse._events.push(t)}UFX.mouse.drag=null;e.preventDefault();return false};UFX.mouse._onmousemove=function(e){if(!UFX.mouse.active)return true;var t=UFX.mouse._geteventpos(e,UFX.mouse._element);UFX.mouse.pos=t;if(UFX.mouse.drag){UFX.mouse.drag.pos=t;UFX.mouse.drag.dx=t[0]-UFX.mouse.drag.pos0[0];UFX.mouse.drag.dy=t[1]-UFX.mouse.drag.pos0[1];UFX.mouse.drag.dt=Date.now()-UFX.mouse.drag.t0}return false};UFX.mouse._onmousewheel=function(e){if(!UFX.mouse.active||!UFX.mouse.capture.wheel)return true;var t="wheelDelta"in e?e.wheelDelta/40:-e.detail;UFX.mouse.wheeldy+=t;if(UFX.mouse.qwheel){var n={type:"wheel",pos:UFX.mouse._geteventpos(e,UFX.mouse._element),dy:t,time:Date.now(),baseevent:e};UFX.mouse._events.push(n)}e.preventDefault();return false};if(typeof UFX=="undefined")UFX={};UFX.touch={capture:{start:true,end:true,tap:true,hold:true,swipe:true,release:true},active:true,multi:true,touchmax:0,tmulti:100,usetouchid:true,ps:[],qtap:true,qdrag:true,thold:300,roundpos:true,dmove:50,_events:[],_mtouch:0,_touches:{},_tkeys:[],_ntouches:0,init:function(e,t){this._captureevents(e,t)},events:function(){this._checkhold();var e=this._events;this._events=[];return e},state:function(){var e={ps:{},deltas:{}};var t=this.capture,n=this.usetouchid;for(var r in t)e[r]=[];this.events().forEach(function(r){if(!t[r.type])return;var i=n?r.touchid:r.id,s;if(r.type=="tap"){s={dt:r.dt}}else if(r.type=="release"){s={dt:r.dt,v:r.v,multi:r.multi}}else{s={}}s.id=i;s.pos=r.pos;s.t=r.t;e[r.type].push(s)});e.ids=[];for(var i in this._touches){var s=this._touches[i],o=n?s.touchid:i;if(!s.followed)continue;e.ids.push(o);var u=s.pos,a=s.opos;e.ps[o]=u;e.deltas[o]=[u[0]-a[0],u[1]-a[1]];s.ot=s.t;s.opos=u}e.ids.sort();return e},twotouchstate:function(e){if(e.ids.length!=2)return null;var t=e.ids[0],n=e.ids[1];var r=e.ps[t][0],i=e.ps[t][1];var s=e.ps[n][0],o=e.ps[n][1];var u=s-r,a=o-i;var f=Math.sqrt(u*u+a*a);var l=f?Math.atan2(a,u):0;var c=r-e.deltas[t][0],h=i-e.deltas[t][1];var p=s-e.deltas[n][0],d=o-e.deltas[n][1];var v=p-c,m=d-h;var g=Math.sqrt(v*v+m*m);var y=g?Math.atan2(m,v):0;return{center:[(r+s)/2,(i+o)/2],dcenter:[(r+s-c-p)/2,(i+o-h-o)/2],r:f,dr:f-g,rratio:g?f/g:1,theta:l,dtheta:l-y}},_captureevents:function(e,t){function n(e,t){return function(n){e[t](n)}}e=e||document;t=t||document;if(typeof e=="string")e=document.getElementById(e);if(typeof t=="string")t=document.getElementById(t);e.ontouchstart=n(this,"_ontouchstart");e.ontouchmove=n(this,"_ontouchmove");e.ontouchend=n(this,"_ontouchend");this._element=e;this._backdrop=t},_addevent:function(e,t,n,r){if(this.capture[e]&&this._touches[t].followed){r.type=e;r.id=t;r.touchid=n;this._events.push(r)}},_handlestart:function(e){if(!this.active)return;var t=e.identifier,n=this._ntouches++;var r=this._eventpos(e),i=Date.now();this._touches[t]={id:t,touchid:n,t0:i,pos0:r,tlast:i,poslast:r,ot:i,opos:r,t:i,pos:r,moved:false,followed:true,held:false,multi:1,multit0:i,vx:0,vy:0};this._settkeys();if(this.touchmax&&this._tkeys.length>this.touchmax){this._touches[t].followed=false}this._addevent("start",t,n,{pos:r,t:i});if(this.multi){}},_handlemove:function(e){if(!this.active)return;var t=e.identifier;if(!this._touches[t])this._handlestart(e);var n=this._touches[t];var r=this._eventpos(e),i=Date.now();var s=i-n.t,o=r[0]-n.pos[0],u=r[1]-n.pos[1];var a=r[0]-n.pos0[0],f=r[1]-n.pos0[1];n.t=i;n.pos=r;if(!n.moved&&Math.abs(a)+Math.abs(f)>this.dmove){n.moved=true}if(s){n.vx=1e3*o/s+7;n.vy=1e3*u/s}this._checkhold()},_handleend:function(e){if(!this.active)return;var t=e.identifier;if(!this._touches[t])return;var n=this._touches[t];var r=this._eventpos(e);var i=Date.now(),s=i-n.t0;this._addevent("end",n.id,n.touchid,{t:i,dt:s,pos:r});if(!n.moved&&!n.held){this._addevent("tap",n.id,n.touchid,{t:i,dt:s,pos:r})}else{this._addevent("release",n.id,n.touchid,{t:i,dt:s,pos0:n.pos0,pos:r,v:[n.vx,n.vy],multi:n.multi})}delete this._touches[t]},_settkeys:function(){this._tkeys=[];for(var e in this._touches)this._tkeys.push(e);this._tkeys.sort();var t=this._tkeys.length;for(var e in this._touches){this._touches[e].multi=Math.max(this._touches[e].multi,t)}},_checkhold:function(){var e=Date.now();for(var t in this._touches){var n=this._touches[t];if(n.held||n.moved)continue;if(n.t0+this.thold>e)continue;n.held=true;this._addevent("hold",n.id,n.touchid,{t:n.t0+this.thold,pos:n.pos})}},_ontouchstart:function(e){this.ps=this._getps(e.touches);this._mtouch=Math.max(this._mtouch,e.touches.length);for(var t=0;t<e.changedTouches.length;++t){this._handlestart(e.changedTouches[t])}this._checkhold();e.preventDefault()},_ontouchmove:function(e){this.ps=this._getps(e.touches);this._mtouch=Math.max(this._mtouch,e.touches.length);for(var t=0;t<e.changedTouches.length;++t){this._handlemove(e.changedTouches[t])}this._checkhold();e.preventDefault()},_ontouchend:function(e){this.ps=this._getps(e.touches);this._mtouch=Math.max(this._mtouch,e.touches.length);this._checkhold();for(var t=0;t<e.changedTouches.length;++t){this._handleend(e.changedTouches[t])}if(!e.touches.length)this._mtouch=0;this._settkeys();e.preventDefault()},_eventpos:function(e,t){t=t||this._element;var n=t.getBoundingClientRect();var r=n.left+t.clientLeft-t.scrollLeft;var i=n.top+t.clientTop-t.scrollTop;var s=e.clientX-r,o=e.clientY-i;return this.roundpos?[Math.round(s),Math.round(o)]:[s,o]},_getps:function(e){var t=[];for(var n=0;n<e.length;++n){t.push(this._eventpos(e[n],this._element))}return t}};if(typeof UFX=="undefined")UFX={};UFX.Thing=function(){var e=Object.create(UFX.Thing.prototype);for(var t=0;t<arguments.length;++t){e.addcomp(arguments[t])}return e};UFX.Thing.prototype={_createmethod:function(e,t,n){n=n||[];var r;if(!t){r=function(){var e;for(var t=0;t<n.length;++t){e=n[t].apply(this,arguments)}return e}}else if(t==="any"){r=function(){var e;for(var t=0;t<n.length;++t){e=n[t].apply(this,arguments);if(e)return e}return e}}else if(t==="all"){r=function(){var e;for(var t=0;t<n.length;++t){e=n[t].apply(this,arguments);if(!e)return e}return e}}else if(t==="getarray"){r=function(){var e=[];for(var t=0;t<n.length;++t){e.push(n[t].apply(this,arguments))}return e}}else if(t==="putarray"){r=function(e){var t=[];for(var r=0;r<n.length;++r){t.push(n[r].apply(this,e[r]))}return t}}else{}r.mlist=n;return r},definemethod:function(e,t){if(this[e])return this;this[e]=this._createmethod(e,t);return this},addcomp:function(e){if(e instanceof Array){var t=e.slice(0);for(var n=0;n<t.length;++n){arguments[0]=t[n];this.addcomp.apply(this,arguments)}return this}for(var r in e){if(r=="init"||r=="remove")continue;if(typeof e[r]!="function")continue;this.definemethod(r);this[r].mlist.push(e[r])}if(e.init){e.init.apply(this,[].slice.call(arguments,1))}return this},removecomp:function(e){if(e instanceof Array){var t=e.slice(0);for(var n=0;n<t.length;++n){arguments[0]=t[n];this.removecomp.apply(this,arguments)}return this}if(e.remove){e.remove.apply(this,[].slice.call(arguments,1))}for(var r in e){if(r=="init"||r=="remove")continue;if(!(r in this))continue;this[r].mlist=this[r].mlist.filter(function(t){return t!==e[r]})}return this},reversemethods:function(e){this[e].mlist.reverse();return this},setmethodmode:function(e,t){this[e]=this._createmethod(e,t,this[e]?this[e].mlist:[]);return this},normalize:function(){for(mname in this){if(this.hasOwnProperty(mname)&&this[mname].mlist&&this[mname].mlist.length==1){this[mname]=this[mname].mlist[0]}}}};UFX.Component={};UFX.Component.HasChildren={init:function(){this.children=[]},nchildren:function(){return this.children.length},_addchild:function(e){this.children.push(e);return this},_removechild:function(e){this.children=this.children.filter(function(t){return t!==e});return this},lastchild:function(){return this.children[this.children.length-1]},die:function(){for(var e=0;e<this.children.length;++e){this.children[e].die()}},think:function(){for(var e=0;e<this.children.length;++e){this.children[e].think.apply(this.children[e],arguments)}},draw:function(e){for(var t=0;t<this.children.length;++t){e.save();this.children[t].draw(e);e.restore()}}};UFX.Component.SortChildren={init:function(e){this.childsortfunc=e||function(e,t){return e.z-t.z}},addchild:function(e){this.children.sort(this.childsortfunc)}};UFX.Component.HasParent={init:function(e){this.attachto(e)},attachto:function(e){if(this.parent){this.parent._removechild(this)}this.parent=e;if(this.parent){this.parent._addchild(this)}return this},detach:function(){return this.attachto()},die:function(){return this.detach()}};var settings={gamename:"0",version:"LD-0",DEBUG:window.location.href.indexOf("DEBUG")>-1,silent:window.location.href.indexOf("SILENT")>-1,ghostv:32,Dmin:.5};var beaten={};var things=[];var WorldBound={init:function(e,t){this.x=e||0;this.y=t||0},draw:function(){UFX.draw("t",this.x,this.y)}};var Ticks={init:function(){this.t=0},think:function(e){this.t+=e}};var Transitions={init:function(){this.trans=null},think:function(e){if(!this.trans)return;this.trans.think(e,this);if(this.trans.done){if(this.trans.kills)this.done=true;this.trans=null}},draw:function(){if(this.trans){this.trans.draw(this)}},halts:function(){return this.trans&&this.trans.halts}};var Clickable={init:function(e){this.r=e||0},hits:function(e,t){var n=e-this.x,r=t-this.y;return n*n+r*r<this.r*this.r},draw:function(){if(settings.DEBUG){UFX.draw("b o 0 0",this.r,"lw 0.03 ss red s")}}};var Unclickable={hits:function(){return false}};var Collectible={init:function(){this.collectible=true}};var Disposible={init:function(){this.disposible=true}};var FreesSister={think:function(e){if(this.active&&!this.sister.free){this.sister.free=true;this.sister.trans=new GrowFadeHalt(this.sister)}}};var WobbleOnActive={init:function(e,t){this.womega=e||2.6;this.wbeta=t||.12;this.wf=0},think:function(e){this.wf+=(this.active?2:-2)*e;this.wf=clip(this.wf,0,1)},draw:function(){if(this.wf){var e=Math.exp(this.wf*this.wbeta*Math.sin(this.t*this.womega));UFX.draw("z",e,1/e)}}};var Rocks={draw:function(){var e=20*Math.sin(this.t*.1);UFX.draw("r",e)}};var FacesActive={init:function(){this.A=0},think:function(e){var t=things.filter(function(e){return e.active});if(!t.length)return;var n=t[0].x-this.x,r=t[0].y-this.y;var i=Math.atan2(n,-r),s=zmod(i-this.A,tau);this.A+=5*e*s},draw:function(){UFX.draw("r",this.A)}};var DrawPath={init:function(e){this.path=e||"b o 0 0 2"},draw:function(e,t,n){if(!e){t=true;n=0}if(n>=1){UFX.draw("lw 0.2",this.path,"fs #CCC ss black f s")}else if(t){var r=clip(Math.floor(192*n),0,192)+32;var i=clip(Math.floor(255*(1-n)),0,255);var s="rgb("+r+","+r+","+r+")";var o="rgb("+i+","+i+","+i+")";UFX.draw("lw 0.2",this.path,"fs",s,"ss",o,"f s")}else{UFX.draw("lw 0.2",this.path,"alpha",n,"fs #CCC ss black f s")}}};var DrawTcircle={draw:function(){UFX.draw("b o 0 0 1 lw 0.3 s b o 0 0 0.5 f")}};var DrawTtriangle={draw:function(){UFX.draw("( m 1 0.6 l -1 0.6 l 0 -1.4 ) lw 0.3 s");UFX.draw("[ z 0.4 0.4 ( m 1 0.6 l -1 0.6 l 0 -1.4 ) ] f")}};var DrawTsquare={draw:function(){UFX.draw("lw 0.3 sr -1 -1 2 2 fr -0.5 -0.5 1 1")}};var DrawStar={draw:function(){UFX.draw("z 0.2 0.2 ( m 0 4 l 1 1 l 4 0 l 1 -1 l 0 -4 l -1 -1 l -4 0 l -1 1 ) f")}};var DrawString={draw:function(){if(this.active||this.trans||this.done)return;if(this.sister.active||this.sister.trans||this.sister.done)return;UFX.draw("[ b m",this.x,this.y,"l",this.sister.x,this.sister.y,"lw 0.1 s ]")}};Piece.prototype=UFX.Thing().addcomp(WorldBound).addcomp(Ticks).addcomp(Transitions).addcomp(WobbleOnActive,null,.05).addcomp(DrawPath).addcomp(Clickable,2);Target.prototype=UFX.Thing().addcomp(WorldBound).addcomp(Ticks).addcomp(Transitions).addcomp(WobbleOnActive).addcomp(DrawTcircle).addcomp(Clickable,1.4).addcomp(Disposible);Dagger.prototype=UFX.Thing().addcomp(WorldBound).addcomp(Ticks).addcomp(Transitions).addcomp(FacesActive).addcomp(DrawTtriangle).addcomp(Clickable,1.4).addcomp(Disposible);Sister.prototype=UFX.Thing().addcomp(DrawString).addcomp(WorldBound).addcomp(Ticks).addcomp(Transitions).addcomp(DrawTsquare).addcomp(Clickable,1.4).addcomp(Disposible).addcomp(FreesSister);Bit.prototype=UFX.Thing().addcomp(WorldBound).addcomp(Ticks).addcomp(Transitions).addcomp(Rocks).addcomp(DrawStar).addcomp(Unclickable).addcomp(Collectible);var FiniteLife={init:function(e){this.T=e||1},think:function(e){if(this.t>this.T){this.t=this.T;this.done=true}}};var LinearTrans={think:function(e){this.f=this.t/this.T}};var NonLinearTrans={init:function(e){this.p=e||0;this.A=e?1/(Math.exp(this.p)-1):0},think:function(e){var t=this.t/this.T;this.f=this.p?this.A*(Math.exp(this.p*t)-1):t}};var Hesitates={init:function(e){this.hT0=e||0;this.hT=0},think:function(e){this.hT+=e;this.t=Math.max(Math.min(this.t,this.hT-this.hT0),0)}};Spin.prototype=UFX.Thing().addcomp(Ticks).addcomp(FiniteLife,.8).addcomp(NonLinearTrans,-1).addcomp({draw:function(e){UFX.draw("r",this.f*tau)}});Deploy.prototype=UFX.Thing().addcomp(Ticks).addcomp(Hesitates).addcomp(FiniteLife,.8).addcomp(NonLinearTrans,-3).addcomp({init:function(){this.halts=true},draw:function(e){UFX.draw("t",-e.x*(1-this.f),-e.y*(1-this.f))}});Undeploy.prototype=UFX.Thing().addcomp(Ticks).addcomp(Hesitates).addcomp(FiniteLife,.8).addcomp(NonLinearTrans,-3).addcomp({init:function(){this.kills=true;this.halts=true},draw:function(e){UFX.draw("t",-e.x*this.f,-e.y*this.f)}});GrowFade.prototype=UFX.Thing().addcomp(Ticks).addcomp(FiniteLife,.5).addcomp(NonLinearTrans).addcomp({init:function(){this.kills=true},draw:function(e){s=1+2*this.f;UFX.draw("z",s,s,"alpha",1-this.f)}});GrowFadeHalt.prototype=UFX.Thing().addcomp(Ticks).addcomp(FiniteLife,.5).addcomp(NonLinearTrans).addcomp({init:function(){this.kills=true;this.halts=true},draw:function(e){s=1+2*this.f;UFX.draw("z",s,s,"alpha",1-this.f)}});Ghost.prototype=UFX.Thing().addcomp(Ticks).addcomp(FiniteLife,.3).addcomp(NonLinearTrans,-3).addcomp({getf:function(e){var t=clip(e/this.T,0,1);return this.p?this.A*(Math.exp(this.p*t)-1):t},getpos:function(e){var t=this.getf(e);return[this.thing1.x*t+this.thing0.x*(1-t),this.thing1.y*t+this.thing0.y*(1-t)]},draw:function(){UFX.draw("[ t",this.getpos(this.t),"b o 0 0 0.4 f ]");UFX.draw("[ t",this.getpos(this.t-.02),"b o 0 0 0.3 f ]");UFX.draw("[ t",this.getpos(this.t-.03),"b o 0 0 0.2 f ]")},halts:function(){return true}}).addcomp(Unclickable);var levels={};levels[0]={ppath:"b o 0 0 3.6",px:0,py:0,pr:3.6,targetps:[[-8,-8],[8,-8],[-8,8],[8,8]],sisterps:[[-4,-12,12,4],[-12,-4,4,12],[4,-12,-12,4],[12,-4,-4,12]],daggerps:[[-12,-12],[12,-12],[-12,12],[12,12]],bitks:[[9,5],[2,11],[0,3],[3,4],[1,2],[16,6]],bitxs:[[1,2,5,10],[5,12,3,4],[14,4,0,6],[11,3,2,4],[9,7,0,5],[14,12,5,8]]};levels.north={ppath:"[ r 3.1416 t 0 -1.8 ( m -4 0.2 q -3.9 1.7 -2.8 2.8 q -1.7 3.9 -0.2 4 l 0.2 4 q 1.7 3.9 2.8 2.8 q 3.9 1.7 4 0.2 ) ]",px:0,py:-1.8,targetps:[[-5,-8],[5,-8],[10,0],[5,8],[-5,8],[-10,0]],bitks:[[0,1,.7],[0,2,.7],[0,3,.7],[0,4,.7],[0,5,.7],[0,6,.7],[1,2]],bitxs:[[2,4,3,5],[1,5,4,6]]};levels.northwest={ppath:"[ r 3.1416 t -1.8 -1.8 ( m 0.2 0.2 l 4 0.2 q 3.9 1.7 2.8 2.8 q 1.7 3.9 0.2 4 ) ]",px:-1.8,py:-1.8,targetps:[[-10,-10],[0,-10],[10,-10],[10,0],[10,10],[0,10],[-10,10],[-10,0]],bitks:[[1,2],[1,8],[8,7],[0,3,.7],[0,6,.7],[4,6],[5,6]],bitxs:[[1,4,2,8],[2,4,3,6],[0,7,5,8]]};levels.northeast={ppath:"[ r -1.5708 t -1.8 -1.8 ( m 0.2 0.2 l 4 0.2 q 3.9 1.7 2.8 2.8 q 1.7 3.9 0.2 4 ) ]",px:1.8,py:-1.8,targetps:[[-9,-7],[-3,-7],[3,-7],[9,-7],[-9,7],[-3,7],[3,7],[9,7]],bitks:[[0,8,.75],[0,4],[2,5,.75],[4,7,.25]],bitxs:[[0,1,2,6],[0,5,1,6],[2,8,3,5]]};levels.south={ppath:"[ t 0 -1.8 ( m -4 0.2 q -3.9 1.7 -2.8 2.8 q -1.7 3.9 -0.2 4 l 0.2 4 q 1.7 3.9 2.8 2.8 q 3.9 1.7 4 0.2 ) ]",px:0,py:1.8,targetps:[[-10,-10],[-6,-6],[6,-6],[10,-10],[-10,10],[-6,6],[6,6],[10,10]],bitks:[[1,4],[5,8],[0,2],[0,3],[0,6],[0,7]],bitxs:[[1,3,2,4],[1,6,2,5],[3,8,4,7],[5,7,6,8]]};levels.southeast={ppath:"[ t -1.8 -1.8 ( m 0.2 0.2 l 4 0.2 q 3.9 1.7 2.8 2.8 q 1.7 3.9 0.2 4 ) ]",px:1.8,py:1.8,targetps:[[-10,-10],[10,-10],[-10,10],[10,10]],daggerps:[[0,-10],[-10,0],[10,0],[0,10]],bitks:[[1,6],[1,0],[5,0],[2,0],[2,7],[6,0],[7,0],[3,6],[6,8],[0,8],[7,8],[4,7]],bitxs:[]};levels.southwest={ppath:"[ r 1.5708 t -1.8 -1.8 ( m 0.2 0.2 l 4 0.2 q 3.9 1.7 2.8 2.8 q 1.7 3.9 0.2 4 ) ]",px:-1.8,py:1.8,targetps:[],sisterps:[[-10,-5,-5,-10],[5,-10,10,-5],[-10,5,-5,10],[5,10,10,5]],bitks:[[1,4],[2,6],[3,7],[5,8]],bitxs:[[2,6,5,8],[5,8,3,7]]};levels.west={ppath:"[ r 1.5708 t 0 -1.8 ( m -4 0.2 q -3.9 1.7 -2.8 2.8 q -1.7 3.9 -0.2 4 l 0.2 4 q 1.7 3.9 2.8 2.8 q 3.9 1.7 4 0.2 ) ]",px:-1.8,py:0,targetps:[[-24,0],[-8,0],[0,-10],[0,10],[8,0],[24,0]],sisterps:[[-16,-10,-16,10],[16,-10,16,10]],bitks:[[3,9],[7,8],[9,10]],bitxs:[[1,9,2,3],[7,6,3,5],[8,6,5,4],[10,1,2,4],[0,3,1,9],[0,4,1,10]]};levels.east={ppath:"[ r -1.5708 t 0 -1.8 ( m -4 0.2 q -3.9 1.7 -2.8 2.8 q -1.7 3.9 -0.2 4 l 0.2 4 q 1.7 3.9 2.8 2.8 q 3.9 1.7 4 0.2 ) ]",px:1.8,py:0,targetps:[[0,-12],[-8,-8],[8,-8],[-12,0],[12,0],[-8,8],[8,8],[0,12]],daggerps:[[0,-8],[-8,0],[8,0],[0,8]],bitks:[[1,9],[8,12],[4,10],[11,5],[2,4],[5,7],[9,2],[12,7]],bitxs:[[2,6,4,8],[3,7,1,5],[0,1,3,4],[0,8,5,6],[0,4,2,8],[0,5,3,8],[9,4,0,2],[9,5,0,3],[12,4,0,6],[12,5,0,7]]};var camera={think:function(e,t){var n=canvas.width,r=canvas.height,i=Math.min(n,r);var s=12,o=12;things.forEach(function(e){if(e.x)s=Math.max(Math.abs(e.x),s);if(e.y)o=Math.max(Math.abs(e.y),o)});this.x0=n/2;this.y0=r/2;this.z=Math.min(n/(2*s+4),r/(2*o+4))*(t||1)},screentoworld:function(e){if(!e)return null;return[(e[0]-this.x0)/this.z,(e[1]-this.y0)/this.z]},draw:function(){UFX.draw("t",this.x0,this.y0,"z",this.z,this.z)}};UFX.scenes.select={start:function(e,t){var n=getlevels();things=[];var r=null;n.forEach(function(n){var i=levels[n];var s=new Piece(n,i.ppath,i.px,i.py,i.pr);if(!t&&n==e){s.trans=new Deploy(s);r=s}else{things.push(s)}});if(!r&&e){r=new Piece(e,levels[e].ppath,0,0,levels[e].pr);r.trans=new GrowFadeHalt(r)}if(r)things.push(r);this.selected=r;this.done=false},thinkargs:function(e){var t=false,n=[-1e3,-1e3];if(UFX.mouse.active){UFX.mouse.events().forEach(function(e){t=t||e.type=="down"});n=UFX.mouse.pos}else if(UFX.touch.active){UFX.touch.events().forEach(function(e){t=t||e.type=="start";n=e.pos})}return[e,camera.screentoworld(n),t]},think:function(e,t,n){if(this.selected&&!this.done){if(!this.selected.trans){this.selected=null}}var r=this.selected&&this.selected.trans;things.forEach(function(e){r=r||e.halts()});if(!r&&n){var i=t[0],s=t[1];var o=null;things.forEach(function(e){if(e.hits(i,s)){o=e}});if(o){play("note-34");this.done=true;this.selected=o;o.trans=new Undeploy(o);things.splice(things.indexOf(o),1);things.push(o)}}things.forEach(function(t){t.think(e)});things=things.filter(function(e){return!e.done});if(this.selected&&this.done){if(!this.selected.trans){UFX.scene.swap("main",this.selected.name)}}this.f=1;if(this.selected){this.f=this.selected.trans?this.selected.trans.f:1;if(this.done)this.f=1-this.f;this.f=clip(this.f,0,1)}camera.think(e,1+this.f)},draw:function(){var e=clip(Math.floor(255*this.f),0,255);var t="rgb("+e+","+e+","+e+")";UFX.draw("[ fs",t,"f0 fs black ss black");camera.draw();var n=this.selected,r=this.f;things.forEach(function(e){context.save();e.draw(true,e===n,r);context.restore()});UFX.draw("]");drawdebuginfo()}};UFX.scenes.main={start:function(e){this.levelname=e;var t=levels[e];things=[];this.piece=new Piece(e,t.ppath,0,0,t.pr);this.athing=this.piece;this.piece.active=true;things.push(this.piece);t.targetps.forEach(function(e){things.push(new Target(e[0],e[1]))});if(t.sisterps){t.sisterps.forEach(function(e){var t=new Sister(e[0],e[1]);var n=new Sister(e[2],e[3],t);t.sister=n;things.push(t);things.push(n)})}if(t.daggerps){t.daggerps.forEach(function(e){things.push(new Dagger(e[0],e[1]))})}t.bitks.forEach(function(e){var t=things[e[0]],n=things[e[1]],r=e[2]||.5;things.push(new Bit((1-r)*t.x+r*n.x,(1-r)*t.y+r*n.y))});t.bitxs.forEach(function(e){var t=e.map(function(e){return things[e].x});var n=e.map(function(e){return things[e].y});var r=(t[0]-t[1])*(n[2]-n[3])-(n[0]-n[1])*(t[2]-t[3]);var i=(t[0]*n[1]-n[0]*t[1])*(t[2]-t[3])-(t[0]-t[1])*(t[2]*n[3]-n[2]*t[3]);var s=(t[0]*n[1]-n[0]*t[1])*(n[2]-n[3])-(n[0]-n[1])*(t[2]*n[3]-n[2]*t[3]);things.push(new Bit(i/r,s/r))});things.forEach(function(e){e.trans=new Deploy(e)});things.reverse();this.clickedhome=false;this.scored=false;this.homet=.3},thinkargs:function(e){var t=false,n=[-1e3,-1e3];if(UFX.mouse.active){UFX.mouse.events().forEach(function(e){t=t||e.type=="down"});n=UFX.mouse.pos}else if(UFX.touch.active){UFX.touch.events().forEach(function(e){t=t||e.type=="start";n=e.pos})}return[e,camera.screentoworld(n),t]},think:function(e,t,n){this.dirty=true;var r=false;things.forEach(function(e){r=r||e.halts()});var i=null;this.ptarget=null;if(!r&&!this.clickedhome){var s=t[0],o=t[1];things.forEach(function(e){if(e.hits(s,o)){i=e}});if(!n&&i&&!i.active){this.ptarget=i}if(n&&i&&!i.active){if(i instanceof Dagger){if(this.athing&&!(this.athing instanceof Piece)){this.collect(this.athing,i);i.done=true;things.unshift(new Ghost(i,this.athing));play("note-3")}}else{if(this.athing){this.athing.active=false;this.collect(this.athing,i);if(this.athing.disposible){this.athing.done=true}things.unshift(new Ghost(this.athing,i));play("note-3")}this.athing=i;this.athing.active=true}}}things.forEach(function(t){t.think(e)});things=things.filter(function(e){return!e.done});camera.think(e);if(this.clickedhome){this.homet-=e;if(this.homet<=0){if(!this.scored){this.score()}if(things.length==1){if(this.superfluous){UFX.scene.swap("select",this.levelname);play("note-543")}else{beaten[this.levelname]=true;UFX.scene.swap("select",this.levelname,true);play(this.levelname=="0"?"fin":"note-346")}}}}if(n&&i===this.piece){this.clickedhome=true;this.piece.active=false}if(settings.DEBUG)this.dirty=true},collect:function(e,t){var n=t.x-e.x,r=t.y-e.y,i=n*n+r*r;things.forEach(function(t){if(!t.collectible)return;var s=t.x-e.x,o=t.y-e.y;var u=s*n+o*r;var a=clip(u/i,0,1);var f=t.x-(e.x+a*n);var l=t.y-(e.y+a*r);if(f*f+l*l<=settings.Dmin*settings.Dmin){t.trans=new GrowFade;play("note-68")}})},score:function(){var e=things.filter(function(e){return!e.done&&!(e.trans&&e.trans.kills)});if(e.length>1){this.superfluous=true;var t=this.piece;e.forEach(function(e){if(e!==t&&!e.trans){e.trans=new Undeploy(e)}})}else{this.superfluous=false}this.scored=true},draw:function(){if(!this.dirty)return;UFX.draw("[ fs black f0 fs white ss white");camera.draw();if(this.ptarget&&this.athing){UFX.draw("lw 0.05 m",this.athing.x,this.athing.y,"l",this.ptarget.x,this.ptarget.y,"s")}things.forEach(function(e){context.save();e.draw();context.restore()});UFX.draw("]");drawdebuginfo()}};if(settings.DEBUG){window.onerror=function(e,t,n){document.body.innerHTML="<p>Error in: "+t+"<p>line "+n+"<pre>"+e+"</pre>"}}var tau=6.283185307179586;var canvas=null,context=null;window.onload=function(){document.title=settings.gamename;canvas=document.createElement("canvas");document.body.insertBefore(canvas,null);context=canvas.getContext("2d");UFX.draw.setcontext(context);UFX.maximize.resizemode="total";UFX.maximize.fill(canvas);UFX.scene.init({minups:10,maxups:200});UFX.scene.push("select");UFX.mouse.init(canvas);UFX.mouse.qup=false;UFX.mouse.qdown=true;UFX.touch.active=false;UFX.touch.capture={start:true};canvas.ontouchstart=function(e){UFX.touch.active=true;UFX.touch.init(canvas);UFX.mouse.active=false}};UFX.resource.onload=function(){for(var e in UFX.resource.sounds){if(e.indexOf("note")>-1){UFX.resource.sounds[e]=new UFX.resource.Multisound(UFX.resource.sounds[e])}}};UFX.resource.load({"note-3":"sound/note-3.ogg","note-34":"sound/note-34.ogg","note-68":"sound/note-68.ogg","note-346":"sound/note-346.ogg","note-543":"sound/note-543.ogg",fin:"sound/fin.ogg"})